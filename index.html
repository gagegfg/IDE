<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Rendimiento Industrial Avanzado</title>
    
    <!-- Librerías Externas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --background-light: #f8f9fa;
            --background-dark: #212529;
            --card-bg: #ffffff;
            --text-color: #343a40;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 0.75rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-color);
        }

        .main-container {
            padding-top: 2rem;
        }

        .filter-container {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .kpi-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--secondary-color);
            text-transform: uppercase;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .chart-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            height: 100%;
        }
        
        .chart-title {
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        #loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="container-fluid main-container">
        <h1 class="h2 mb-4 text-center">Dashboard de Análisis de Producción Industrial</h1>

        <!-- Contenedor de Carga -->
        <div id="loading-spinner" class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>

        <!-- Filtros -->
        <div class="container filter-container">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h5>Panel de Control</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">Rango de Fechas:</span>
                        <input type="text" id="date-range-picker" class="form-control" placeholder="Seleccione un rango de fechas">
                    </div>
                </div>
                 <div class="col-md-3 text-end">
                    <button id="reset-filters" class="btn btn-secondary">Limpiar Filtros</button>
                </div>
            </div>
        </div>

        <!-- KPIs Principales -->
        <div class="container">
            <div class="row g-4 mb-4">
                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card">
                        <div class="kpi-title">Producción Total (Unidades)</div>
                        <div id="kpi-total-production" class="kpi-value">0</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card">
                        <div class="kpi-title">Tiempo Muerto Total (Horas)</div>
                        <div id="kpi-total-downtime" class="kpi-value">0</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card">
                        <div class="kpi-title">Producciones Registradas</div>
                        <div id="kpi-total-runs" class="kpi-value">0</div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="kpi-card">
                        <div class="kpi-title">Eficiencia vs Objetivo</div>
                        <div id="kpi-target-efficiency" class="kpi-value">0%</div>
                    </div>
                </div>
            </div>

            <!-- Gráficos -->
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="chart-card">
                        <h5 class="chart-title">Causas Principales de Tiempo Muerto (Minutos)</h5>
                        <div id="downtime-chart"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-card">
                        <h5 class="chart-title">Producción Total por Máquina</h5>
                        <div id="production-by-machine-chart"></div>
                    </div>
                </div>
                 <div class="col-lg-12">
                    <div class="chart-card">
                        <h5 class="chart-title">Producción Diaria a lo Largo del Tiempo</h5>
                        <div id="production-over-time-chart"></div>
                    </div>
                </div>
                <div class="col-lg-12">
                     <div class="chart-card">
                        <h5 class="chart-title">Top 10 Operarios por Producción</h5>
                        <div id="operator-performance-chart"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Librerías de JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- ESTADO Y VARIABLES GLOBALES ---
            let originalData = [];
            let charts = {};
            const spinner = document.getElementById('loading-spinner');

            // --- INICIALIZACIÓN ---
            async function init() {
                spinner.style.display = 'block';
                try {
                    // Carga y parseo de datos usando D3, especificando el delimitador ";"
                    const rawData = await d3.dsv(";", "exportProduccionyEventos.csv");
                    
                    // Pre-procesamiento de los datos
                    originalData = rawData.map(d => {
                        const [day, month, year] = d.Fecha.split('/');
                        return {
                            ...d,
                            Cantidad: +d.Cantidad || 0,
                            Minutos: +d.Minutos || 0,
                            Objetivo: +d.Objetivo || 0,
                            HsTrab: +d['Hs Trab'] || 0,
                            FechaObj: new Date(`${year}-${month}-${day}`),
                            Operario: `${d.Operario} ${d.Apellido}`.trim(),
                        };
                    });

                    setupFilters();
                    updateDashboard(originalData);

                } catch (error) {
                    console.error("Error al cargar o procesar los datos:", error);
                    alert("No se pudo cargar el archivo CSV. Verifique la consola para más detalles.");
                } finally {
                    spinner.style.display = 'none';
                }
            }

            // --- CONFIGURACIÓN DE FILTROS ---
            function setupFilters() {
                const datePicker = flatpickr("#date-range-picker", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "es",
                    onChange: function (selectedDates) {
                        if (selectedDates.length === 2) {
                            applyFilters();
                        }
                    }
                });

                document.getElementById('reset-filters').addEventListener('click', () => {
                    datePicker.clear();
                    applyFilters();
                });
            }

            // --- LÓGICA DE FILTRADO ---
            function applyFilters() {
                const dateRange = document.getElementById('date-range-picker').value;
                let filteredData = originalData;

                if (dateRange) {
                    const [startStr, endStr] = dateRange.split(' a ');
                    if (startStr && endStr) {
                         const [startDay, startMonth, startYear] = startStr.split('/');
                         const startDate = new Date(`${startYear}-${startMonth}-${startDay}`);
                         startDate.setHours(0, 0, 0, 0);

                         const [endDay, endMonth, endYear] = endStr.split('/');
                         const endDate = new Date(`${endYear}-${endMonth}-${endDay}`);
                         endDate.setHours(23, 59, 59, 999);
                        
                        filteredData = originalData.filter(d => d.FechaObj >= startDate && d.FechaObj <= endDate);
                    }
                }
                
                updateDashboard(filteredData);
            }

            // --- ACTUALIZACIÓN DEL DASHBOARD ---
            function updateDashboard(data) {
                updateKPIs(data);
                createOrUpdateDowntimeChart(data);
                createOrUpdateProductionByMachineChart(data);
                createOrUpdateProductionOverTimeChart(data);
                createOrUpdateOperatorPerformanceChart(data);
            }

            // --- ACTUALIZACIÓN DE KPIs ---
            function updateKPIs(data) {
                // Usar un Set para contar producciones únicas
                const uniqueProductions = new Set(data.map(d => d.IdProduccion));

                const totalProduction = d3.sum(data.filter((d, i, self) => 
                    self.findIndex(s => s.IdProduccion === d.IdProduccion) === i
                ), d => d.Cantidad);

                const totalDowntimeMinutes = d3.sum(data, d => d.Minutos);
                const totalObjective = d3.sum(data.filter((d, i, self) => 
                    self.findIndex(s => s.IdProduccion === d.IdProduccion) === i && d.Objetivo > 0
                ), d => d.Objetivo);

                const efficiency = totalObjective > 0 ? (totalProduction / totalObjective) * 100 : 0;

                document.getElementById('kpi-total-production').textContent = totalProduction.toLocaleString('es-AR');
                document.getElementById('kpi-total-downtime').textContent = (totalDowntimeMinutes / 60).toFixed(1);
                document.getElementById('kpi-total-runs').textContent = uniqueProductions.size;
                document.getElementById('kpi-target-efficiency').textContent = `${efficiency.toFixed(1)}%`;
            }

            // --- LÓGICA DE GRÁFICOS ---
            
            // Gráfico de Causas de Tiempo Muerto
            function createOrUpdateDowntimeChart(data) {
                const downtimeData = aggregateAndSort(data, 'descrip_incidencia', 'Minutos');
                const top10Downtime = downtimeData.slice(0, 10);
                
                const options = {
                    series: [{ name: 'Minutos', data: top10Downtime.map(d => d.value) }],
                    chart: { type: 'bar', height: 350, toolbar: { show: true } },
                    plotOptions: { bar: { borderRadius: 4, horizontal: true } },
                    dataLabels: { enabled: true, formatter: val => val.toFixed(0) },
                    xaxis: { categories: top10Downtime.map(d => d.category) },
                    tooltip: { y: { formatter: val => `${val} minutos` } },
                };
                renderChart('downtime-chart', options);
            }

            // Gráfico de Producción por Máquina
            function createOrUpdateProductionByMachineChart(data) {
                const machineData = aggregateAndSort(data, 'Descrip_Maquina', 'Cantidad', 'sum', true);

                const options = {
                    series: [{ name: 'Unidades', data: machineData.map(d => d.value) }],
                    chart: { type: 'bar', height: 350, toolbar: { show: true } },
                    plotOptions: { bar: { columnWidth: '50%', distributed: true } },
                    dataLabels: { enabled: false },
                    legend: { show: false },
                    xaxis: { categories: machineData.map(d => d.category), labels: { rotate: -45, trim: true, style: { fontSize: '10px' } } },
                    yaxis: { title: { text: 'Unidades Producidas' } },
                };
                renderChart('production-by-machine-chart', options);
            }
            
            // Gráfico de Producción a lo Largo del Tiempo
            function createOrUpdateProductionOverTimeChart(data) {
                const timeData = aggregateAndSort(data, 'FechaObj', 'Cantidad', 'sum', true, false);
                
                // Asegurarse de que las fechas están ordenadas
                timeData.sort((a,b) => new Date(a.category) - new Date(b.category));

                const options = {
                    series: [{ name: 'Producción', data: timeData.map(d => d.value) }],
                    chart: { type: 'area', height: 350, zoom: { enabled: true } },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth' },
                    xaxis: { type: 'datetime', categories: timeData.map(d => new Date(d.category).getTime()), labels: { format: 'dd MMM' } },
                    tooltip: { x: { format: 'dd/MM/yyyy' } },
                };
                renderChart('production-over-time-chart', options);
            }

            // Gráfico de Rendimiento de Operarios
            function createOrUpdateOperatorPerformanceChart(data) {
                const operatorData = aggregateAndSort(data, 'Operario', 'Cantidad', 'sum', true);
                const top10Operators = operatorData.slice(0, 10);

                const options = {
                    series: [{ name: 'Unidades Producidas', data: top10Operators.map(d => d.value) }],
                    chart: { type: 'bar', height: 350 },
                    plotOptions: { bar: { borderRadius: 4, horizontal: false } },
                    dataLabels: { enabled: false },
                    xaxis: { categories: top10Operators.map(d => d.category), labels: { style: { fontSize: '10px' } } },
                    yaxis: { title: { text: 'Unidades Producidas' } },
                };
                renderChart('operator-performance-chart', options);
            }
            
            // --- FUNCIÓN UTILITARIA PARA RENDERIZAR GRÁFICOS ---
            function renderChart(elementId, options) {
                if (charts[elementId]) {
                    charts[elementId].updateOptions(options);
                } else {
                    const chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    chart.render();
                    charts[elementId] = chart;
                }
            }
            
            // --- FUNCIÓN UTILITARIA DE AGREGACIÓN Y ORDENACIÓN ---
            function aggregateAndSort(data, categoryField, valueField, method = 'sum', uniqueByIdProd = false, sortByValue = true) {
                const aggregation = new Map();
                const seenIds = uniqueByIdProd ? new Set() : null;

                data.forEach(row => {
                    const category = categoryField === 'FechaObj' ? row.FechaObj.toISOString().split('T')[0] : row[category];
                    if (!category) return;
                    
                    let shouldAdd = true;
                    if (uniqueByIdProd) {
                        const uniqueKey = `${row.IdProduccion}`;
                        if (seenIds.has(uniqueKey)) {
                            shouldAdd = false;
                        } else {
                            seenIds.add(uniqueKey);
                        }
                    }

                    if (shouldAdd) {
                        const currentValue = aggregation.get(category) || 0;
                        aggregation.set(category, currentValue + row[valueField]);
                    }
                });

                let aggregatedArray = Array.from(aggregation, ([category, value]) => ({ category, value }));

                if (sortByValue) {
                    aggregatedArray.sort((a, b) => b.value - a.value);
                }

                return aggregatedArray;
            }

            // --- Iniciar la aplicación ---
            init();
        });
    </script>
</body>
</html>
