<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Rendimiento Industrial</title>
    
    <!-- Librerías Externas -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 280px;
            --primary-color: #0d6efd;
            --background-light: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #343a40;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 0.75rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-light);
            color: var(--text-color);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background-color: var(--card-bg);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }
        
        .sidebar h3 {
            font-weight: 700;
            color: var(--primary-color);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .kpi-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            text-align: center;
            transition: transform 0.2s;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
        }
        .kpi-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            text-transform: uppercase;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .chart-card {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            height: 100%;
        }
        
        .chart-title {
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        #loading-spinner {
            position: fixed;
            top: 50%;
            left: calc(50% + var(--sidebar-width) / 2);
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="mb-4">Panel de Control</h3>
        
        <div class="mb-3">
            <label for="date-range-picker" class="form-label">Rango de Fechas</label>
            <input type="text" id="date-range-picker" class="form-control" placeholder="Seleccione fechas">
        </div>

        <div class="mb-3">
            <label for="machine-filter" class="form-label">Máquina</label>
            <select id="machine-filter" class="form-select">
                <option value="all">Todas</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="operator-filter" class="form-label">Operario</label>
            <select id="operator-filter" class="form-select">
                <option value="all">Todos</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="shift-filter" class="form-label">Turno</label>
            <select id="shift-filter" class="form-select">
                <option value="all">Todos</option>
            </select>
        </div>

        <div class="d-grid gap-2 mt-4">
            <button id="apply-filters" class="btn btn-primary">Aplicar Filtros</button>
            <button id="reset-filters" class="btn btn-outline-secondary">Limpiar Filtros</button>
        </div>
    </div>

    <main class="main-content">
        <h1 class="h2 mb-4">Dashboard de Análisis de Producción</h1>

        <div id="loading-spinner" class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-title">Producción Total</div>
                    <div id="kpi-total-production" class="kpi-value">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-title">Tiempo Muerto (Horas)</div>
                    <div id="kpi-total-downtime" class="kpi-value">0</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-title">Lotes de Producción</div>
                    <div id="kpi-total-runs" class="kpi-value">0</div>
                </div>
            </div>
             <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="kpi-title">Cumplimiento Objetivo</div>
                    <div id="kpi-target-efficiency" class="kpi-value">0%</div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-xl-6">
                <div class="chart-card">
                    <h5 class="chart-title">Causas de Tiempo Muerto (Minutos)</h5>
                    <div id="downtime-chart"></div>
                </div>
            </div>
            <div class="col-xl-6">
                <div class="chart-card">
                    <h5 class="chart-title">Producción por Máquina</h5>
                    <div id="production-by-machine-chart"></div>
                </div>
            </div>
            <div class="col-xl-12 mt-4">
                <div class="chart-card">
                    <h5 class="chart-title">Producción Diaria</h5>
                    <div id="production-over-time-chart"></div>
                </div>
            </div>
            <div class="col-xl-12 mt-4">
                <div class="chart-card">
                    <h5 class="chart-title">Top 10 Operarios por Producción</h5>
                    <div id="operator-performance-chart"></div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let originalData = [];
            let charts = {};
            const spinner = document.getElementById('loading-spinner');
            
const csvDataString = `IdProduccion;Fecha;Turno;Objetivo;Encargado;Máquina_Prod;Descrip_Maquina;Operario;Apellido;Cantidad;Hs Trab;Hs Descanso;Observaciones;IdIncidencia;NroIncidencia;descrip_incidencia;Frecuencia;Minutos;SinOperario
189796;01/08/2025;06-14;40000;18;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298720;10;Cambio de Bobina;2;20;False
189796;01/08/2025;06-14;40000;18;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298721;14;Incidencia Papel;2;20;False
189796;01/08/2025;06-14;40000;18;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298722;2;Limpieza en Proceso;2;40;False
189797;01/08/2025;06-14;0;18;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298723;4;Ajuste de mantenimiento;1;30;False
189797;01/08/2025;06-14;0;18;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298724;14;Incidencia Papel;1;15;False
189797;01/08/2025;06-14;0;18;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298725;10;Cambio de Bobina;1;10;False
189797;01/08/2025;06-14;0;18;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298726;2;Limpieza en Proceso;1;15;False
189798;01/08/2025;06-14;0;18;11;Pan Dulcera 11;397;Calidad;4500;275;;;298727;4;Ajuste de mantenimiento;2;60;False
189798;01/08/2025;06-14;0;18;11;Pan Dulcera 11;397;Calidad;4500;275;;;298728;2;Limpieza en Proceso;1;30;False
189799;01/08/2025;14-22;40000;18;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298729;4;Ajuste de mantenimiento;2;30;False
189799;01/08/2025;14-22;40000;18;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298730;2;Limpieza en Proceso;1;30;False
189799;01/08/2025;14-22;40000;18;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298731;10;Cambio de Bobina;1;10;False
189800;01/08/2025;14-22;40000;18;9;Pan Dulcera 9;109;Pacheco;25000;255;;;298732;4;Ajuste de mantenimiento;2;120;False
189800;01/08/2025;14-22;40000;18;9;Pan Dulcera 9;109;Pacheco;25000;255;;;298733;2;Limpieza en Proceso;2;30;False
189801;01/08/2025;14-22;40000;18;10;Pan Dulcera 10;241;Villaroel;42500;430;;;298734;14;Incidencia Papel;2;20;False
189801;01/08/2025;14-22;40000;18;10;Pan Dulcera 10;241;Villaroel;42500;430;;;298735;10;Cambio de Bobina;2;20;False
189802;01/08/2025;22-06;40000;18;11;Pan Dulcera 11;345;Rojas;48000;480;;;298736;14;Incidencia Papel;2;20;False
189802;01/08/2025;22-06;40000;18;11;Pan Dulcera 11;345;Rojas;48000;480;;;298737;10;Cambio de Bobina;2;20;False
189803;01/08/2025;22-06;40000;18;13;Pan Dulcera 13;396;Calidad;13000;460;;;298738;14;Incidencia Papel;1;15;False
189803;01/08/2025;22-06;40000;18;13;Pan Dulcera 13;396;Calidad;13000;460;;;298739;2;Limpieza en Proceso;1;15;False
189803;01/08/2025;22-06;40000;18;13;Pan Dulcera 13;396;Calidad;13000;460;;;298740;4;Ajuste de mantenimiento;1;30;False
189804;01/08/2025;22-06;40000;18;9;Pan Dulcera 9;385;Acuña;45000;450;;;298741;14;Incidencia Papel;2;20;False
189804;01/08/2025;22-06;40000;18;9;Pan Dulcera 9;385;Acuña;45000;450;;;298742;10;Cambio de Bobina;2;20;False
189805;02/08/2025;06-14;40000;;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298743;10;Cambio de Bobina;2;20;False
189805;02/08/2025;06-14;40000;;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298744;14;Incidencia Papel;2;20;False
189805;02/08/2025;06-14;40000;;9;Pan Dulcera 9;189;Avendaño;41000;400;;;298745;2;Limpieza en Proceso;2;40;False
189806;02/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298746;4;Ajuste de mantenimiento;1;30;False
189806;02/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298747;14;Incidencia Papel;1;15;False
189806;02/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298748;10;Cambio de Bobina;1;10;False
189806;02/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;298749;2;Limpieza en Proceso;1;15;False
189807;02/08/2025;06-14;0;;11;Pan Dulcera 11;397;Calidad;4500;275;;;298750;4;Ajuste de mantenimiento;2;60;False
189807;02/08/2025;06-14;0;;11;Pan Dulcera 11;397;Calidad;4500;275;;;298751;2;Limpieza en Proceso;1;30;False
189808;02/08/2025;14-22;40000;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298752;4;Ajuste de mantenimiento;2;30;False
189808;02/08/2025;14-22;40000;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298753;2;Limpieza en Proceso;1;30;False
189808;02/08/2025;14-22;40000;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;298754;10;Cambio de Bobina;1;10;False
189809;02/08/2025;14-22;40000;;9;Pan Dulcera 9;109;Pacheco;25000;255;;;298755;4;Ajuste de mantenimiento;2;120;False
189809;02/08/2025;14-22;40000;;9;Pan Dulcera 9;109;Pacheco;25000;255;;;298756;2;Limpieza en Proceso;2;30;False
189810;02/08/2025;14-22;40000;;10;Pan Dulcera 10;241;Villaroel;42500;430;;;298757;14;Incidencia Papel;2;20;False
189810;02/08/2025;14-22;40000;;10;Pan Dulcera 10;241;Villaroel;42500;430;;;298758;10;Cambio de Bobina;2;20;False
189811;02/08/2025;22-06;40000;;11;Pan Dulcera 11;345;Rojas;48000;480;;;298759;14;Incidencia Papel;2;20;False
189811;02/08/2025;22-06;40000;;11;Pan Dulcera 11;345;Rojas;48000;480;;;298760;10;Cambio de Bobina;2;20;False
189812;02/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;298761;14;Incidencia Papel;1;15;False
189812;02/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;298762;2;Limpieza en Proceso;1;15;False
189812;02/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;298763;4;Ajuste de mantenimiento;1;30;False
189813;02/08/2025;22-06;40000;;9;Pan Dulcera 9;385;Acuña;45000;450;;;298764;14;Incidencia Papel;2;20;False
189813;02/08/2025;22-06;40000;;9;Pan Dulcera 9;385;Acuña;45000;450;;;298765;10;Cambio de Bobina;2;20;False
190058;30/08/2025;06-14;40000;0;9;Pan Dulcera 9;189;Avendaño;41000;400;;;299634;10;Cambio de Bobina;2;20;False
190058;30/08/2025;06-14;40000;0;9;Pan Dulcera 9;189;Avendaño;41000;400;;;299635;14;Incidencia Papel;2;20;False
190058;30/08/2025;06-14;40000;0;9;Pan Dulcera 9;189;Avendaño;41000;400;;;299636;2;Limpieza en Proceso;2;40;False
190062;30/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;299637;4;Ajuste de mantenimiento;1;30;False
190062;30/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;299638;14;Incidencia Papel;1;15;False
190062;30/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;299639;10;Cambio de Bobina;1;10;False
190062;30/08/2025;06-14;0;;10;Pan Dulcera 10;211;Alvarez;25500;310;;;299640;2;Limpieza en Proceso;1;15;False
190069;30/08/2025;06-14;0;;11;Pan Dulcera 11;397;Calidad;4500;275;;;299641;4;Ajuste de mantenimiento;2;60;False
190069;30/08/2025;06-14;0;;11;Pan Dulcera 11;397;Calidad;4500;275;;;299642;2;Limpieza en Proceso;1;30;False
190070;30/08/2025;06-14;0;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;299643;4;Ajuste de mantenimiento;2;30;False
190070;30/08/2025;06-14;0;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;299644;2;Limpieza en Proceso;1;30;False
190070;30/08/2025;06-14;0;;13;Pan Dulcera 13;331;Torrez Pantoja;41400;410;;;299645;10;Cambio de Bobina;1;10;False
190071;30/08/2025;14-22;40000;;9;Pan Dulcera 9;109;Pacheco;25000;255;;;299646;4;Ajuste de mantenimiento;2;120;False
190071;30/08/2025;14-22;40000;;9;Pan Dulcera 9;109;Pacheco;25000;255;;;299647;2;Limpieza en Proceso;2;30;False
190072;30/08/2025;14-22;40000;;10;Pan Dulcera 10;241;Villaroel;42500;430;;;299648;14;Incidencia Papel;2;20;False
190072;30/08/2025;14-22;40000;;10;Pan Dulcera 10;241;Villaroel;42500;430;;;299649;10;Cambio de Bobina;2;20;False
190073;30/08/2025;22-06;40000;;11;Pan Dulcera 11;345;Rojas;48000;480;;;299650;14;Incidencia Papel;2;20;False
190073;30/08/2025;22-06;40000;;11;Pan Dulcera 11;345;Rojas;48000;480;;;299651;10;Cambio de Bobina;2;20;False
190074;30/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;299652;14;Incidencia Papel;1;15;False
190074;30/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;299653;2;Limpieza en Proceso;1;15;False
190074;30/08/2025;22-06;40000;;13;Pan Dulcera 13;396;Calidad;13000;460;;;299654;4;Ajuste de mantenimiento;1;30;False
190075;30/08/2025;22-06;40000;;9;Pan Dulcera 9;385;Acuña;45000;450;;;299655;14;Incidencia Papel;2;20;False
190075;30/08/2025;22-06;40000;;9;Pan Dulcera 9;385;Acuña;45000;450;;;299656;10;Cambio de Bobina;2;20;False
`;

            function init() {
                spinner.style.display = 'block';
                try {
                    const parser = d3.dsvFormat(";");
                    const rawData = parser.parse(csvDataString);

                    if (!rawData || rawData.length === 0) {
                        throw new Error("Los datos CSV están vacíos o no se pudieron interpretar.");
                    }
                    
                    originalData = rawData.map(d => {
                        if (!d.Fecha) return null;
                        const [day, month, year] = d.Fecha.split('/');
                        const fechaObj = new Date(Date.UTC(year, month - 1, day));
                        
                        return {
                            ...d,
                            Cantidad: +d.Cantidad || 0,
                            Minutos: +d.Minutos || 0,
                            Objetivo: +d.Objetivo || 0,
                            FechaObj: fechaObj,
                            Operario: `${d.Operario} ${d.Apellido}`.trim(),
                        };
                    }).filter(d => d && d.FechaObj instanceof Date && !isNaN(d.FechaObj));

                    populateFilters(originalData);
                    setupEventListeners();
                    updateDashboard(originalData);

                } catch (error) {
                    console.error("Fallo crítico en la inicialización:", error);
                    alert(`Error al procesar los datos: ${error.message}.`);
                } finally {
                    spinner.style.display = 'none';
                }
            }
            
            function populateFilters(data) {
                const machines = [...new Set(data.map(d => d.Descrip_Maquina))].sort();
                const operators = [...new Set(data.map(d => d.Operario))].sort();
                const shifts = [...new Set(data.map(d => d.Turno))].sort();

                const machineFilter = document.getElementById('machine-filter');
                machines.forEach(m => machineFilter.innerHTML += `<option value="${m}">${m}</option>`);
                const operatorFilter = document.getElementById('operator-filter');
                operators.forEach(o => operatorFilter.innerHTML += `<option value="${o}">${o}</option>`);
                const shiftFilter = document.getElementById('shift-filter');
                shifts.forEach(s => shiftFilter.innerHTML += `<option value="${s}">${s}</option>`);
            }

            function setupEventListeners() {
                flatpickr("#date-range-picker", { mode: "range", dateFormat: "d/m/Y", locale: "es" });
                document.getElementById('apply-filters').addEventListener('click', applyFilters);
                document.getElementById('reset-filters').addEventListener('click', () => {
                    document.getElementById('date-range-picker')._flatpickr.clear();
                    document.getElementById('machine-filter').value = 'all';
                    document.getElementById('operator-filter').value = 'all';
                    document.getElementById('shift-filter').value = 'all';
                    applyFilters();
                });
            }

            function applyFilters() {
                const dateRange = document.getElementById('date-range-picker')._flatpickr.selectedDates;
                const selectedMachine = document.getElementById('machine-filter').value;
                const selectedOperator = document.getElementById('operator-filter').value;
                const selectedShift = document.getElementById('shift-filter').value;

                let filteredData = originalData;

                if (dateRange.length === 2) {
                    const [start, end] = dateRange;
                    end.setUTCHours(23, 59, 59, 999);
                    filteredData = filteredData.filter(d => d.FechaObj >= start && d.FechaObj <= end);
                }
                if (selectedMachine !== 'all') filteredData = filteredData.filter(d => d.Descrip_Maquina === selectedMachine);
                if (selectedOperator !== 'all') filteredData = filteredData.filter(d => d.Operario === selectedOperator);
                if (selectedShift !== 'all') filteredData = filteredData.filter(d => d.Turno === selectedShift);
                
                updateDashboard(filteredData);
            }

            function updateDashboard(data) {
                // Para cálculos de producción, es VITAL usar solo registros únicos por IdProduccion
                // para no sumar la misma cantidad múltiples veces.
                const uniqueProductions = Array.from(new Map(data.map(item => [item.IdProduccion, item])).values());
                
                updateKPIs(data, uniqueProductions);
                renderDowntimeChart(data);
                renderProductionByMachineChart(uniqueProductions);
                renderProductionOverTimeChart(uniqueProductions);
                renderOperatorPerformanceChart(uniqueProductions);
            }

            function updateKPIs(allData, uniqueProductions) {
                const totalProduction = d3.sum(uniqueProductions, d => d.Cantidad);
                const totalDowntimeMinutes = d3.sum(allData, d => d.Minutos);
                
                // --- LÓGICA DE EFICIENCIA CORREGIDA ---
                // Solo consideramos producciones que tenían un objetivo definido (> 0)
                const productionsWithTarget = uniqueProductions.filter(d => d.Objetivo > 0);
                const targetProduction = d3.sum(productionsWithTarget, d => d.Cantidad);
                const totalObjective = d3.sum(productionsWithTarget, d => d.Objetivo);
                const efficiency = totalObjective > 0 ? (targetProduction / totalObjective) * 100 : 0;

                document.getElementById('kpi-total-production').textContent = totalProduction.toLocaleString('es-AR');
                document.getElementById('kpi-total-downtime').textContent = (totalDowntimeMinutes / 60).toFixed(1);
                document.getElementById('kpi-total-runs').textContent = uniqueProductions.length;
                document.getElementById('kpi-target-efficiency').textContent = `${efficiency.toFixed(1)}%`;
            }
            
            function renderDowntimeChart(data) {
                const downtimeData = d3.rollup(data.filter(d => d.descrip_incidencia), v => d3.sum(v, d => d.Minutos), d => d.descrip_incidencia);
                const sortedDowntime = Array.from(downtimeData, ([category, value]) => ({ category, value })).sort((a,b) => b.value - a.value).slice(0, 10);
                
                const options = {
                    series: [{ name: 'Minutos', data: sortedDowntime.map(d => d.value) }],
                    chart: { type: 'bar', height: 350, toolbar: { show: true } },
                    plotOptions: { bar: { borderRadius: 4, horizontal: true } },
                    dataLabels: { enabled: true, formatter: val => val.toFixed(0) },
                    xaxis: { categories: sortedDowntime.map(d => d.category) },
                    tooltip: { y: { formatter: val => `${val.toLocaleString('es-AR')} minutos` } },
                };
                renderChart('downtime-chart', options);
            }

            function renderProductionByMachineChart(uniqueProductions) {
                const machineData = d3.rollup(uniqueProductions, v => d3.sum(v, d => d.Cantidad), d => d.Descrip_Maquina);
                const sortedMachineData = Array.from(machineData, ([category, value]) => ({ category, value })).sort((a,b) => b.value - a.value);

                const options = {
                    series: [{ name: 'Unidades', data: sortedMachineData.map(d => d.value) }],
                    chart: { type: 'bar', height: 350, toolbar: { show: true } },
                    plotOptions: { bar: { columnWidth: '50%', distributed: true } },
                    legend: { show: false },
                    xaxis: { categories: sortedMachineData.map(d => d.category), labels: { rotate: -45, trim: true, style: { fontSize: '10px' } } },
                    yaxis: { title: { text: 'Unidades Producidas' } },
                };
                renderChart('production-by-machine-chart', options);
            }
            
            function renderProductionOverTimeChart(uniqueProductions) {
                // --- LÓGICA DE GRÁFICO DE TIEMPO CORREGIDA ---
                const timeData = d3.rollup(uniqueProductions, v => d3.sum(v, d => d.Cantidad), d => d.FechaObj.toISOString().split('T')[0]);
                const sortedTimeData = Array.from(timeData, ([date, value]) => ({ date, value })).sort((a, b) => new Date(a.date) - new Date(b.date));

                const options = {
                    series: [{ name: 'Producción', data: sortedTimeData.map(d => d.value) }],
                    chart: { type: 'area', height: 350, zoom: { enabled: true } },
                    stroke: { curve: 'smooth' },
                    xaxis: { type: 'datetime', categories: sortedTimeData.map(d => new Date(d.date).getTime()), labels: { datetimeUTC: false, format: 'dd MMM \'yy' } },
                    tooltip: { x: { format: 'dd/MM/yyyy' } },
                };
                renderChart('production-over-time-chart', options);
            }

            function renderOperatorPerformanceChart(uniqueProductions) {
                const operatorData = d3.rollup(uniqueProductions, v => d3.sum(v, d => d.Cantidad), d => d.Operario);
                const sortedOperatorData = Array.from(operatorData, ([category, value]) => ({ category, value })).sort((a,b) => b.value - a.value).slice(0, 10);

                const options = {
                    series: [{ name: 'Unidades Producidas', data: sortedOperatorData.map(d => d.value) }],
                    chart: { type: 'bar', height: 350 },
                    xaxis: { categories: sortedOperatorData.map(d => d.category), labels: { style: { fontSize: '10px' } } },
                    yaxis: { title: { text: 'Unidades Producidas' } },
                };
                renderChart('operator-performance-chart', options);
            }
            
            function renderChart(elementId, options) {
                if (charts[elementId]) {
                    charts[elementId].updateOptions(options, true, true);
                } else {
                    const chart = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    chart.render();
                    charts[elementId] = chart;
                }
            }

            init();
        });
    </script>
</body>
</html>
