<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Industrial v2.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        :root {
            --sidebar-width: 320px;
            --primary-color: #5E35B1;
            --secondary-color: #039BE5;
            --accent-color: #00897B;
            --danger-color: #E53935;
            
            /* Light Theme */
            --bg-color: #f4f6f9;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --text-color-dark: #333;
            --text-color-light: #777;
            --border-color: #e0e0e0;
            --card-shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
        }

        body[data-theme="dark"] {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --text-color-dark: #e0e0e0;
            --text-color-light: #a0a0a0;
            --border-color: #333;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .filter-section { flex-grow: 1; }
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 2.5rem;
            position: relative;
        }
        #loading-overlay {
            position: fixed; top: 0; left: var(--sidebar-width); right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        #loading-overlay.d-none { opacity: 0; pointer-events: none; }
        .card {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            background-color: var(--card-bg);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s, border-color 0.3s;
        }
        .card:hover { transform: translateY(-5px); }
        .card-header {
            background-color: transparent; border-bottom: 1px solid var(--border-color);
            font-weight: 600; font-size: 1rem; padding: 1rem 1.25rem;
            color: var(--text-color-dark);
            transition: border-color 0.3s, color 0.3s;
        }
        .kpi-value { font-size: 2.2rem; font-weight: 700; color: var(--text-color-dark); }
        .text-muted { color: var(--text-color-light) !important; }
        
        /* Choices.js Dark Theme */
        body[data-theme="dark"] .choices__inner { background-color: #333; border-color: #555; }
        body[data-theme="dark"] .choices__list--dropdown { background-color: #333; border-color: #555; }
        body[data-theme="dark"] .choices__list--dropdown .choices__item { color: #e0e0e0; }
        
        @media (max-width: 992px) {
            body { display: block; }
            .sidebar { position: relative; width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border-color); }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
            #loading-overlay { left: 0; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h4 class="mb-4" style="color: var(--primary-color); font-weight: 700;">Dashboard Industrial</h4>
        <div class="filter-section">
            <div class="mb-3">
                <label class="form-label fw-bold">Rango de Fechas</label>
                <input type="text" id="date-range-picker" class="form-control mb-2" placeholder="Seleccione un rango...">
                 <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnHoy">Hoy</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAyer">Ayer</button>
                </div>
                 <div class="btn-group w-100 mt-1" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMesActual">Mes Actual</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMesAnterior">Mes Ant.</button>
                </div>
            </div>
            <div class="mb-3">
                <label for="machine-filter" class="form-label fw-bold">Máquinas</label>
                <select id="machine-filter" multiple></select>
            </div>
            <div class="mb-3">
                <label for="shift-filter" class="form-label fw-bold">Turnos</label>
                <select id="shift-filter" multiple></select>
            </div>
        </div>
        <div>
            <button id="reset-filters" class="btn btn-danger w-100 mt-3">Limpiar Filtros</button>
            <div class="form-check form-switch mt-4 d-flex justify-content-center">
                <input class="form-check-input" type="checkbox" role="switch" id="theme-toggle">
                <label class="form-check-label ms-2" for="theme-toggle">Modo Oscuro</label>
            </div>
            <p id="last-updated" class="text-muted text-center mt-3 small">Actualizado: Cargando...</p>
        </div>
    </nav>

    <main class="main-content">
        <div id="loading-overlay">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        </div>
        
        <header class="mb-4">
            <h1 class="h2 fw-bold">Análisis de Rendimiento de Producción</h1>
        </header>

        <section class="row mb-4 g-4">
            <div class="col-lg-3 col-md-6"><div class="card p-3"><div class="card-body text-center"><h5 class="card-title text-muted">Producción Total</h5><p class="kpi-value" id="kpi-total-production">--</p></div></div></div>
            <div class="col-lg-3 col-md-6"><div class="card p-3"><div class="card-body text-center"><h5 class="card-title text-muted">Disponibilidad</h5><p class="kpi-value" id="kpi-availability">--</p></div></div></div>
            <div class="col-lg-3 col-md-6"><div class="card p-3"><div class="card-body text-center"><h5 class="card-title text-muted">Eficiencia (Pzas/Hr)</h5><p class="kpi-value" id="kpi-efficiency">--</p></div></div></div>
            <div class="col-lg-3 col-md-6"><div class="card p-3"><div class="card-body text-center"><h5 class="card-title text-muted">Horas de Parada</h5><p class="kpi-value" id="kpi-total-downtime">--</p></div></div></div>
        </section>
        
        <section class="row mb-4 g-4">
            <div class="col-12"><div class="card"><div class="card-header">Análisis Inteligente</div><div class="card-body"><p id="summary-text" class="fs-5">Calculando...</p></div></div></div>
        </section>

        <section class="row g-4">
            <div class="col-lg-12 mb-4"><div class="card"><div class="card-header">Producción Diaria</div><div class="card-body"><div id="chart-daily-production"></div></div></div></div>
            <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">Producción por Máquina</div><div class="card-body"><div id="chart-prod-by-machine"></div></div></div></div>
            <div class="col-lg-6 mb-4"><div class="card"><div class="card-header">Producción por Operario</div><div class="card-body"><div id="chart-prod-by-operator"></div></div></div></div>
            <div class="col-lg-12 mb-4"><div class="card"><div class="card-header">Análisis de Paradas (Top 10 en Minutos)</div><div class="card-body"><div id="chart-downtime-reasons"></div></div></div></div>
            <div class="col-lg-12 mb-4"><div class="card"><div class="card-header">Análisis de Pareto de Paradas</div><div class="card-body"><div id="chart-pareto-downtime"></div></div></div></div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const CSV_URL = 'exportProduccionyEventos.csv';

            let originalData = [];
            let charts = {};
            let choicesMachine, choicesShift, datepicker;
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const themeToggle = document.getElementById('theme-toggle');
            const chartColors = ['#5E35B1', '#039BE5', '#00897B', '#FDD835', '#E53935', '#8E24AA', '#3949AB'];

            function applyTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                themeToggle.checked = theme === 'dark';
                // Actualizar todos los gráficos existentes con el nuevo tema
                Object.values(charts).forEach(chart => {
                    chart.updateOptions({
                        theme: { mode: theme },
                        chart: { background: 'transparent' }
                    });
                });
            }

            function initTheme() {
                const savedTheme = localStorage.getItem('dashboardTheme') || 'light';
                applyTheme(savedTheme);
                themeToggle.addEventListener('change', () => {
                    const newTheme = themeToggle.checked ? 'dark' : 'light';
                    localStorage.setItem('dashboardTheme', newTheme);
                    applyTheme(newTheme);
                });
            }

            function toggleLoading(show) {
                loadingOverlay.classList.toggle('d-none', !show);
            }

            function init() {
                initTheme();
                toggleLoading(true);

                Papa.parse(CSV_URL, {
                    download: true, header: true, delimiter: ';', skipEmptyLines: true,
                    transformHeader: header => header.trim().replace(/[\s\W]+/g, '_'),
                    complete: function(results) {
                        originalData = processData(results.data);
                        populateFilters(originalData);
                        addEventListeners();
                        
                        const dates = originalData.map(d => d.Fecha).filter(Boolean);
                        const firstDate = dates.length > 0 ? new Date(Math.min(...dates)) : new Date();
                        const lastDate = dates.length > 0 ? new Date(Math.max(...dates)) : new Date();
                        datepicker.setDate([firstDate, lastDate], true);
                        
                        document.getElementById('last-updated').textContent = `Actualizado: ${new Date().toLocaleString('es-ES')}`;
                    },
                    error: err => {
                        console.error("Error al cargar o parsear el CSV:", err);
                        alert("No se pudo cargar el archivo de datos. Revisa la consola para más detalles.");
                        toggleLoading(false);
                    }
                });
            }

            function processData(data) {
                return data.map(row => {
                    row.Cantidad = parseInt(row.Cantidad) || 0;
                    row.Minutos = parseInt(row.Minutos) || 0;
                    row.Frecuencia = parseInt(row.Frecuencia) || 1; 
                    row.Hs_Trab = parseFloat(String(row.Hs_Trab).replace(',', '.')) || 0;
                    row.Fecha = parseDate(row.Fecha);
                    return row;
                }).filter(row => row.Fecha instanceof Date && !isNaN(row.Fecha));
            }

            function parseDate(dateString) {
                if (!dateString) return null;
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0], 10), month = parseInt(parts[1], 10) - 1, year = parseInt(parts[2], 10);
                    if (!isNaN(day) && !isNaN(month) && !isNaN(year)) return new Date(year, month, day);
                }
                return null;
            }

            function populateFilters(data) {
                const uniqueMachines = [...new Set(data.map(row => row.Descrip_Maquina))].sort();
                const uniqueShifts = [...new Set(data.map(row => row.Turno))].sort();
                const machineFilterEl = document.getElementById('machine-filter');
                uniqueMachines.forEach(machine => machine && machineFilterEl.add(new Option(machine, machine)));
                const shiftFilterEl = document.getElementById('shift-filter');
                uniqueShifts.forEach(shift => shift && shiftFilterEl.add(new Option(shift, shift)));
                choicesMachine = new Choices(machineFilterEl, { removeItemButton: true, placeholder: true, placeholderValue: 'Todas las máquinas...' });
                choicesShift = new Choices(shiftFilterEl, { removeItemButton: true, placeholder: true, placeholderValue: 'Todos los turnos...' });
            }

            function addEventListeners() {
                datepicker = flatpickr("#date-range-picker", { mode: "range", dateFormat: "d/m/Y", locale: "es", onChange: () => applyFilters() });
                document.getElementById('machine-filter').addEventListener('change', applyFilters);
                document.getElementById('shift-filter').addEventListener('change', applyFilters);
                const today = new Date();
                const yesterday = new Date(); yesterday.setDate(today.getDate() - 1);
                document.getElementById('btnHoy').addEventListener('click', () => datepicker.setDate([today, today], true));
                document.getElementById('btnAyer').addEventListener('click', () => datepicker.setDate([yesterday, yesterday], true));
                document.getElementById('btnMesActual').addEventListener('click', () => datepicker.setDate([new Date(today.getFullYear(), today.getMonth(), 1), today], true));
                document.getElementById('btnMesAnterior').addEventListener('click', () => {
                     const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                     const end = new Date(today.getFullYear(), today.getMonth(), 0);
                     datepicker.setDate([start, end], true);
                });
                document.getElementById('reset-filters').addEventListener('click', () => {
                    datepicker.clear();
                    choicesMachine.removeActiveItems();
                    choicesShift.removeActiveItems();
                    applyFilters();
                });
            }

            function applyFilters() {
                toggleLoading(true);
                setTimeout(() => {
                    const dateRange = datepicker.selectedDates;
                    const selectedMachines = choicesMachine.getValue(true);
                    const selectedShifts = choicesShift.getValue(true);
                    const filteredData = originalData.filter(row => {
                        const rowDate = row.Fecha;
                        const startDate = dateRange[0] ? new Date(dateRange[0].setHours(0,0,0,0)) : null;
                        const endDate = dateRange[1] ? new Date(dateRange[1].setHours(23,59,59,999)) : null;
                        const isDateInRange = dateRange.length === 2 ? rowDate >= startDate && rowDate <= endDate : true;
                        const isMachineSelected = selectedMachines.length > 0 ? selectedMachines.includes(row.Descrip_Maquina) : true;
                        const isShiftSelected = selectedShifts.length > 0 ? selectedShifts.includes(row.Turno) : true;
                        return isDateInRange && isMachineSelected && isShiftSelected;
                    });
                    updateDashboard(filteredData);
                }, 50);
            }
            
            function updateDashboard(data) {
                const kpiData = calculateKPIs(data);
                renderKPIs(kpiData);
                updateCharts(data);
                updateSummary(data, kpiData);
                toggleLoading(false);
            }

            function calculateKPIs(data) {
                const uniqueProductions = new Map();
                data.forEach(row => {
                    if (row.IdProduccion && !uniqueProductions.has(row.IdProduccion)) {
                        uniqueProductions.set(row.IdProduccion, { cantidad: row.Cantidad, hsTrab: row.Hs_Trab });
                    }
                });
                const productionValues = Array.from(uniqueProductions.values());
                const totalProduction = productionValues.reduce((sum, item) => sum + item.cantidad, 0);
                const plannedMinutes = productionValues.reduce((sum, item) => sum + item.hsTrab, 0); 
                const totalDowntimeMinutes = data.reduce((sum, row) => sum + row.Minutos, 0);
                const runTimeMinutes = plannedMinutes - totalDowntimeMinutes;
                const availability = plannedMinutes > 0 ? (runTimeMinutes / plannedMinutes) : 0;
                const efficiency = runTimeMinutes > 0 ? totalProduction / (runTimeMinutes / 60) : 0;
                return {
                    totalProduction, totalDowntimeHours: totalDowntimeMinutes / 60,
                    availability: Math.max(0, availability), efficiency
                };
            }

            function renderKPIs(kpiData) {
                document.getElementById('kpi-total-production').textContent = kpiData.totalProduction.toLocaleString('es-ES');
                document.getElementById('kpi-availability').textContent = `${(kpiData.availability * 100).toFixed(1)}%`;
                document.getElementById('kpi-efficiency').textContent = kpiData.efficiency.toFixed(0);
                document.getElementById('kpi-total-downtime').textContent = kpiData.totalDowntimeHours.toFixed(1);
            }
            
            function updateSummary(data, kpiData) {
                if (data.length === 0) {
                    document.getElementById('summary-text').textContent = "No hay datos para el período o filtros seleccionados."; return;
                }
                const downtimeByReason = aggregateAndSort(data, 'descrip_incidencia', 'Minutos');
                const topReason = downtimeByReason[0] ? downtimeByReason[0].category : "N/A";
                const topReasonMins = downtimeByReason[0] ? downtimeByReason[0].value : 0;
                const totalDowntimeMins = kpiData.totalDowntimeHours * 60;
                const topReasonPercentage = totalDowntimeMins > 0 ? (topReasonMins / totalDowntimeMins * 100).toFixed(0) : 0;
                const summary = `El KPI de <strong>Disponibilidad</strong> se sitúa en un <strong>${(kpiData.availability * 100).toFixed(1)}%</strong>. La principal causa de inactividad es <strong>"${topReason}"</strong>, responsable del <strong>${topReasonPercentage}%</strong> del tiempo total de parada.`;
                document.getElementById('summary-text').innerHTML = summary;
            }

            function updateCharts(data) {
                const currentTheme = localStorage.getItem('dashboardTheme') || 'light';
                const textColor = currentTheme === 'dark' ? '#e0e0e0' : '#333';
                const gridBorderColor = currentTheme === 'dark' ? '#444' : '#e7e7e7';
                
                // Producción Diaria (ahora como Barras)
                const dailyProdData = aggregateAndSort(data, 'Fecha', 'Cantidad', false, false);
                renderChart('chart-daily-production', 'bar', {
                    categories: dailyProdData.map(d => new Date(d.category).getTime()),
                    series: [{ name: 'Producción', data: dailyProdData.map(d => d.value) }],
                }, { textColor, gridBorderColor });

                // Otros gráficos
                const prodByMachineData = aggregateAndSort(data, 'Descrip_Maquina', 'Cantidad', true);
                renderChart('chart-prod-by-machine', 'bar', { categories: prodByMachineData.map(d => d.category), series: [{ name: 'Producción', data: prodByMachineData.map(d => d.value) }], horizontal: true }, { textColor, gridBorderColor });
                const prodByOperatorData = aggregateAndSort(data, 'Apellido', 'Cantidad', true);
                renderChart('chart-prod-by-operator', 'bar', { categories: prodByOperatorData.map(d => d.category), series: [{ name: 'Producción', data: prodByOperatorData.map(d => d.value) }], horizontal: false }, { textColor, gridBorderColor });
                const downtimeReasonsData = aggregateAndSort(data, 'descrip_incidencia', 'Minutos');
                renderChart('chart-downtime-reasons', 'bar', { categories: downtimeReasonsData.map(d => d.category).slice(0, 10), series: [{ name: 'Minutos', data: downtimeReasonsData.map(d => d.value).slice(0, 10) }], horizontal: true }, { textColor, gridBorderColor });
                
                // NUEVO: Gráfico de Pareto
                const paretoData = prepareParetoData(downtimeReasonsData);
                renderChart('chart-pareto-downtime', 'pareto', paretoData, { textColor, gridBorderColor });
            }
            
            function renderChart(elementId, type, chartData, themeOptions) {
                const currentTheme = localStorage.getItem('dashboardTheme') || 'light';
                const commonOptions = {
                    chart: { type: 'bar', height: 350, fontFamily: 'Inter, sans-serif', toolbar: { show: true }, background: 'transparent' },
                    theme: { mode: currentTheme },
                    colors: chartColors,
                    grid: { borderColor: themeOptions.gridBorderColor },
                    noData: { text: 'No hay datos para la selección actual.' },
                };

                let options = {};
                if (type === 'bar') {
                     options = {
                        ...commonOptions,
                        series: chartData.series,
                        plotOptions: { bar: { horizontal: chartData.horizontal || false, borderRadius: 4, dataLabels: { position: 'top' } } },
                        dataLabels: { enabled: true, style: { fontSize: '12px', colors: chartData.horizontal ? ["#fff"] : [themeOptions.textColor] }, background: { enabled: true, foreColor: '#333' }, offsetY: -20, dropShadow: { enabled: true, top: 1, left: 1, blur: 1, color: '#000', opacity: 0.45 }},
                        xaxis: { type: chartData.categories[0] > 1000000 ? 'datetime' : 'category', categories: chartData.categories, labels: { style: { colors: themeOptions.textColor, fontSize: '12px' }, trim: true, maxHeight: 100, datetimeUTC: false, format: 'dd MMM' } },
                        yaxis: { labels: { style: { colors: themeOptions.textColor }, formatter: val => val.toLocaleString('es-ES') } },
                        tooltip: { theme: currentTheme, x: { format: chartData.categories[0] > 1000000 ? 'dd/MM/yyyy' : undefined }, y: { formatter: val => val.toLocaleString('es-ES') } }
                    };
                    if (chartData.horizontal) { // Ajuste para etiquetas en barras horizontales
                        options.dataLabels.style.colors = ["#fff"];
                        options.dataLabels.background.enabled = false;
                        options.dataLabels.offsetX = -10;
                    }
                } else if (type === 'pareto') {
                    options = {
                        chart: { type: 'line', height: 350, fontFamily: 'Inter, sans-serif', toolbar: { show: true }, background: 'transparent' },
                        theme: { mode: currentTheme },
                        series: chartData.series,
                        xaxis: { categories: chartData.categories, labels: { style: { colors: themeOptions.textColor } } },
                        yaxis: [
                            { title: { text: "Minutos Totales", style: { color: themeOptions.textColor } }, labels: { style: { colors: themeOptions.textColor } } },
                            { opposite: true, max: 100, title: { text: "Porcentaje Acumulado (%)", style: { color: themeOptions.textColor } }, labels: { style: { colors: themeOptions.textColor } } }
                        ],
                        tooltip: { theme: currentTheme, shared: false, intersect: true,
                            y: {
                                formatter: function (val, { seriesIndex }) {
                                    return seriesIndex === 0 ? val.toLocaleString('es-ES') + " min" : val.toFixed(1) + "%";
                                }
                            }
                        },
                        grid: { borderColor: themeOptions.gridBorderColor },
                        noData: { text: 'No hay datos para la selección actual.' },
                    };
                }

                if (charts[elementId]) {
                    charts[elementId].updateOptions(options);
                } else {
                    charts[elementId] = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    charts[elementId].render();
                }
            }
            
            function aggregateAndSort(data, categoryField, valueField, uniqueByIdProd = false, sortByValue = true) {
                const aggregation = {}; const seenIds = new Set();
                data.forEach(row => {
                    const category = categoryField === 'Fecha' ? row[categoryField].toISOString().split('T')[0] : row[categoryField];
                    if (!category) return;
                    const value = row[valueField] || 0;
                    if (uniqueByIdProd) {
                        const uniqueKey = `${row.IdProduccion}-${category}`;
                        if (!seenIds.has(uniqueKey)) { aggregation[category] = (aggregation[category] || 0) + value; seenIds.add(uniqueKey); }
                    } else { aggregation[category] = (aggregation[category] || 0) + value; }
                });
                let aggregatedArray = Object.keys(aggregation).map(key => ({ category: key, value: aggregation[key] }));
                if (sortByValue) { aggregatedArray.sort((a, b) => b.value - a.value); }
                else if (categoryField === 'Fecha') { aggregatedArray.sort((a, b) => new Date(a.category) - new Date(b.category)); }
                return aggregatedArray;
            }
            
            function prepareParetoData(downtimeData) {
                const totalDowntime = downtimeData.reduce((sum, item) => sum + item.value, 0);
                let cumulativePercentage = 0;
                const paretoLine = downtimeData.map(item => {
                    cumulativePercentage += (item.value / totalDowntime) * 100;
                    return cumulativePercentage;
                });
                return {
                    series: [
                        { name: 'Minutos Totales', type: 'bar', data: downtimeData.map(d => d.value), color: '#5E35B1' },
                        { name: '% Acumulado', type: 'line', data: paretoLine, color: '#E53935' }
                    ],
                    categories: downtimeData.map(d => d.category)
                };
            }

            init();
        });
    </script>
</body>
</html>
