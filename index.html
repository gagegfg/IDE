<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Industrial v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
    <style>
        :root {
            --sidebar-width: 320px;
            --primary-color: #5E35B1; /* Deep Purple */
            --secondary-color: #039BE5; /* Light Blue */
            --accent-color: #00897B; /* Teal */
            --danger-color: #E53935; /* Red */
            --light-bg: #f4f6f9;
            --dark-text: #333;
            --light-text: #777;
            --card-shadow: 0 8px 24px rgba(149, 157, 165, 0.2);
            --border-radius: 0.75rem;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
            display: flex;
        }
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            padding: 1.5rem;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        .filter-section { flex-grow: 1; }
        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 2.5rem;
            position: relative;
        }
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(244, 246, 249, 0.8);
            z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.3s;
        }
        #loading-overlay.d-none { opacity: 0; pointer-events: none; }
        .card {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .card-header {
            background-color: transparent; border-bottom: 1px solid #eee;
            font-weight: 600; font-size: 1rem; padding: 1rem 1.25rem;
        }
        .kpi-value { font-size: 2.2rem; font-weight: 700; color: var(--dark-text); }
        .choices__inner { border-radius: 0.375rem; border-color: #ced4da; }
        .choices__list--multiple .choices__item { background-color: var(--primary-color); border-color: var(--primary-color); }
        #reset-filters { background-color: var(--danger-color); border-color: var(--danger-color); }
        
        @media (max-width: 992px) {
            body { display: block; }
            .sidebar { position: relative; width: 100%; height: auto; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .main-content { margin-left: 0; width: 100%; padding: 1.5rem; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <h4 class="mb-4" style="color: var(--primary-color); font-weight: 700;">Dashboard Industrial</h4>
        <div class="filter-section">
            <div class="mb-3">
                <label class="form-label fw-bold">Rango de Fechas</label>
                <input type="text" id="date-range-picker" class="form-control mb-2" placeholder="Seleccione un rango...">
                 <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnHoy">Hoy</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAyer">Ayer</button>
                </div>
                 <div class="btn-group w-100 mt-1" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMesActual">Mes Actual</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMesAnterior">Mes Ant.</button>
                </div>
            </div>
            <div class="mb-3">
                <label for="machine-filter" class="form-label fw-bold">Máquinas</label>
                <select id="machine-filter" multiple></select>
            </div>
            <div class="mb-3">
                <label for="shift-filter" class="form-label fw-bold">Turnos</label>
                <select id="shift-filter" multiple></select>
            </div>
        </div>
        <div>
            <button id="reset-filters" class="btn btn-danger w-100 mt-3">Limpiar Filtros</button>
            <p id="last-updated" class="text-muted text-center mt-3 small">Actualizado: Cargando...</p>
        </div>
    </nav>

    <main class="main-content">
        <div id="loading-overlay" class="d-none">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        </div>
        
        <header class="mb-4">
            <h1 class="h2 fw-bold">Análisis de Rendimiento de Producción</h1>
        </header>

        <section class="row mb-4 g-4">
            <div class="col-lg-3 col-md-6">
                <div class="card p-3">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Producción Total</h5>
                        <p class="kpi-value" id="kpi-total-production">--</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card p-3">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Disponibilidad</h5>
                        <p class="kpi-value" id="kpi-availability">--</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card p-3">
                    <div class="card-body text-center">
                        <h5 class="card-title text-muted">Eficiencia (Pzas/Hr)</h5>
                        <p class="kpi-value" id="kpi-efficiency">--</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card p-3">
                     <div class="card-body text-center">
                        <h5 class="card-title text-muted">Horas de Parada</h5>
                        <p class="kpi-value" id="kpi-total-downtime">--</p>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="row mb-4 g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Análisis Inteligente</div>
                    <div class="card-body">
                        <p id="summary-text" class="fs-5">Calculando...</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="row g-4">
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header">Producción Diaria</div>
                    <div class="card-body">
                        <div id="chart-daily-production"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">Producción por Máquina</div>
                    <div class="card-body">
                        <div id="chart-prod-by-machine"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card">
                     <div class="card-header">Producción por Operario</div>
                     <div class="card-body">
                        <div id="chart-prod-by-operator"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12 mb-4">
                <div class="card">
                    <div class="card-header">Análisis de Paradas (Minutos)</div>
                     <div class="card-body">
                        <div id="chart-downtime-reasons"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const CSV_URL = 'exportProduccionyEventos.csv';

            let originalData = [];
            let charts = {};
            let choicesMachine, choicesShift, datepicker;
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const chartColors = ['#5E35B1', '#039BE5', '#00897B', '#FDD835', '#E53935', '#8E24AA', '#3949AB'];

            function toggleLoading(show) {
                loadingOverlay.classList.toggle('d-none', !show);
            }

            function checkEnvironment() {
                if (window.location.protocol === 'file:') {
                    document.querySelector('.main-content').innerHTML = `
                        <div class="alert alert-danger"><h4 class="alert-heading">Error de Entorno de Ejecución</h4><p>Este dashboard no puede cargar el archivo de datos (.csv) cuando se abre directamente desde el sistema de archivos (<code>file://</code>).</p><hr><p class="mb-0">Para solucionarlo, ejecute este archivo a través de un <strong>servidor web local</strong>. Una opción fácil es usar la extensión "Live Server" en Visual Studio Code.</p></div>`;
                    return false;
                }
                return true;
            }

            function init() {
                if (!checkEnvironment()) return;

                toggleLoading(true);
                Papa.parse(CSV_URL, {
                    download: true, header: true, delimiter: ';', skipEmptyLines: true,
                    transformHeader: header => header.trim().replace(/[\s\W]+/g, '_'),
                    complete: function(results) {
                        originalData = processData(results.data);
                        populateFilters(originalData);
                        addEventListeners();
                        
                        const firstDate = originalData.length > 0 ? originalData[0].Fecha : new Date();
                        const lastDate = originalData.length > 0 ? originalData[originalData.length - 1].Fecha : new Date();
                        datepicker.setDate([firstDate, lastDate], true);
                        
                        document.getElementById('last-updated').textContent = `Actualizado: ${new Date().toLocaleString('es-ES')}`;
                    },
                    error: function(err) {
                        console.error("Error al cargar o parsear el CSV:", err);
                        alert("No se pudo cargar el archivo de datos. Revisa la consola para más detalles.");
                        toggleLoading(false);
                    }
                });
            }

            function processData(data) {
                // Convertir la coma decimal a punto para el parsing correcto
                return data.map(row => {
                    row.Cantidad = parseInt(row.Cantidad) || 0;
                    row.Minutos = parseInt(row.Minutos) || 0;
                    // FIX: Reemplazar coma por punto para el parseo a float.
                    row.Hs_Trab = parseFloat(String(row.Hs_Trab).replace(',', '.')) || 0;
                    row.Fecha = parseDate(row.Fecha);
                    return row;
                }).filter(row => row.Fecha);
            }

            function parseDate(dateString) {
                if (!dateString) return null;
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return null;
            }

            function populateFilters(data) {
                const uniqueMachines = [...new Set(data.map(row => row.Descrip_Maquina))].sort();
                const uniqueShifts = [...new Set(data.map(row => row.Turno))].sort();
                const machineFilterEl = document.getElementById('machine-filter');
                uniqueMachines.forEach(machine => machineFilterEl.add(new Option(machine, machine)));
                const shiftFilterEl = document.getElementById('shift-filter');
                uniqueShifts.forEach(shift => shiftFilterEl.add(new Option(shift, shift)));
                choicesMachine = new Choices(machineFilterEl, { removeItemButton: true, placeholder: true, placeholderValue: 'Todas las máquinas...' });
                choicesShift = new Choices(shiftFilterEl, { removeItemButton: true, placeholder: true, placeholderValue: 'Todos los turnos...' });
            }

            function addEventListeners() {
                datepicker = flatpickr("#date-range-picker", {
                    mode: "range", dateFormat: "d/m/Y", locale: "es",
                    onChange: () => applyFilters()
                });

                document.getElementById('machine-filter').addEventListener('change', applyFilters);
                document.getElementById('shift-filter').addEventListener('change', applyFilters);
                
                const today = new Date();
                document.getElementById('btnHoy').addEventListener('click', () => datepicker.setDate([today, today], true));
                document.getElementById('btnAyer').addEventListener('click', () => {
                    const yesterday = new Date();
                    yesterday.setDate(today.getDate() - 1);
                    datepicker.setDate([yesterday, yesterday], true);
                });
                document.getElementById('btnMesActual').addEventListener('click', () => datepicker.setDate([new Date(today.getFullYear(), today.getMonth(), 1), today], true));
                document.getElementById('btnMesAnterior').addEventListener('click', () => {
                     const start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                     const end = new Date(today.getFullYear(), today.getMonth(), 0);
                     datepicker.setDate([start, end], true);
                });
                document.getElementById('reset-filters').addEventListener('click', () => {
                    datepicker.clear();
                    choicesMachine.removeActiveItems();
                    choicesShift.removeActiveItems();
                    applyFilters();
                });
            }

            function applyFilters() {
                toggleLoading(true);
                setTimeout(() => {
                    const dateRange = datepicker.selectedDates;
                    const selectedMachines = choicesMachine.getValue(true);
                    const selectedShifts = choicesShift.getValue(true);

                    const filteredData = originalData.filter(row => {
                        const isDateInRange = dateRange.length === 2 ? row.Fecha >= dateRange[0] && row.Fecha <= dateRange[1] : true;
                        const isMachineSelected = selectedMachines.length > 0 ? selectedMachines.includes(row.Descrip_Maquina) : true;
                        const isShiftSelected = selectedShifts.length > 0 ? selectedShifts.includes(row.Turno) : true;
                        return isDateInRange && isMachineSelected && isShiftSelected;
                    });
                    updateDashboard(filteredData);
                }, 50);
            }

            function updateDashboard(data) {
                const kpiData = calculateKPIs(data);
                renderKPIs(kpiData);
                updateCharts(data, kpiData);
                updateSummary(data, kpiData);
                toggleLoading(false);
            }

            // --- LÓGICA DE CÁLCULO ACTUALIZADA ---
            function calculateKPIs(data) {
                const uniqueProductions = new Map();
                data.forEach(row => {
                    if (row.IdProduccion && !uniqueProductions.has(row.IdProduccion)) {
                        uniqueProductions.set(row.IdProduccion, { cantidad: row.Cantidad, hsTrab: row.Hs_Trab });
                    }
                });

                const productionValues = Array.from(uniqueProductions.values());
                const totalProduction = productionValues.reduce((sum, item) => sum + item.cantidad, 0);
                
                // FIX: Según tu aclaración, Hs_Trab ya son minutos, se elimina la multiplicación * 60.
                const plannedMinutes = productionValues.reduce((sum, item) => sum + item.hsTrab, 0); 
                
                const totalDowntimeMinutes = data.reduce((sum, row) => sum + row.Minutos, 0);
                const runTimeMinutes = plannedMinutes - totalDowntimeMinutes;
                
                const availability = plannedMinutes > 0 ? (runTimeMinutes / plannedMinutes) : 0;
                const efficiency = runTimeMinutes > 0 ? totalProduction / (runTimeMinutes / 60) : 0; // Eficiencia sigue en Pzas/Hora

                return {
                    totalProduction,
                    totalDowntimeHours: totalDowntimeMinutes / 60,
                    availability: Math.max(0, availability),
                    efficiency
                };
            }

            function renderKPIs(kpiData) {
                document.getElementById('kpi-total-production').textContent = kpiData.totalProduction.toLocaleString('es-ES');
                document.getElementById('kpi-availability').textContent = `${(kpiData.availability * 100).toFixed(1)}%`;
                document.getElementById('kpi-efficiency').textContent = kpiData.efficiency.toFixed(0);
                document.getElementById('kpi-total-downtime').textContent = kpiData.totalDowntimeHours.toFixed(1);
            }
            
            function updateSummary(data, kpiData) {
                if (data.length === 0) {
                    document.getElementById('summary-text').textContent = "No hay datos para el período o filtros seleccionados.";
                    return;
                }
                const downtimeByReason = aggregateAndSort(data, 'descrip_incidencia', 'Minutos');
                const topReason = downtimeByReason[0] ? downtimeByReason[0].category : "N/A";
                const topReasonMins = downtimeByReason[0] ? downtimeByReason[0].value : 0;
                const totalDowntimeMins = kpiData.totalDowntimeHours * 60;
                const topReasonPercentage = totalDowntimeMins > 0 ? (topReasonMins / totalDowntimeMins * 100).toFixed(0) : 0;

                const summary = `El KPI de <strong>Disponibilidad</strong> se sitúa en un <strong>${(kpiData.availability * 100).toFixed(1)}%</strong>. La principal causa de inactividad es <strong>"${topReason}"</strong>, responsable del <strong>${topReasonPercentage}%</strong> del tiempo total de parada.`;
                document.getElementById('summary-text').innerHTML = summary;
            }

            // --- GRÁFICOS ACTUALIZADOS ---
            function updateCharts(data) {
                const prodByMachineData = aggregateAndSort(data, 'Descrip_Maquina', 'Cantidad', true);
                renderChart('chart-prod-by-machine', 'bar', { 
                    categories: prodByMachineData.map(d => d.category),
                    series: [{ name: 'Producción', data: prodByMachineData.map(d => d.value) }],
                    horizontal: true
                });

                const prodByOperatorData = aggregateAndSort(data, 'Apellido', 'Cantidad', true);
                renderChart('chart-prod-by-operator', 'bar', { 
                    categories: prodByOperatorData.map(d => d.category),
                    series: [{ name: 'Producción', data: prodByOperatorData.map(d => d.value) }],
                    horizontal: false
                });

                const downtimeReasonsData = aggregateAndSort(data, 'descrip_incidencia', 'Minutos');
                renderChart('chart-downtime-reasons', 'bar', { 
                    categories: downtimeReasonsData.map(d => d.category).slice(0, 10),
                    series: [{ name: 'Minutos', data: downtimeReasonsData.map(d => d.value).slice(0, 10) }],
                    horizontal: true
                });

                const dailyProdData = aggregateAndSort(data, 'Fecha', 'Cantidad', false, false);
                renderChart('chart-daily-production', 'line', { 
                    categories: dailyProdData.map(d => d.category),
                    series: [{ name: 'Producción', data: dailyProdData.map(d => d.value) }],
                });
            }

            function renderChart(elementId, type, chartData) {
                const commonOptions = {
                    chart: { 
                        type: type, height: 350, fontFamily: 'Inter, sans-serif', 
                        toolbar: { show: true },
                        // FIX: Deshabilitar zoom con scroll, permitir pan
                        zoom: { enabled: true },
                        events: { mounted: (chart) => chart.toggleZoom(false) } // Previene el zoom al cargar
                    },
                    colors: chartColors,
                    grid: { borderColor: '#e7e7e7', row: { colors: ['#f3f3f3', 'transparent'], opacity: 0.5 } },
                    noData: { text: 'No hay datos para la selección actual.' },
                    tooltip: { y: { formatter: val => val.toLocaleString('es-ES') } }
                };

                let options = {};
                if (type === 'bar') {
                    options = {
                        ...commonOptions, series: chartData.series,
                        plotOptions: { bar: { horizontal: chartData.horizontal, borderRadius: 4, dataLabels: { position: 'top' } } },
                        // FIX: Contraste de texto en barras.
                        dataLabels: { 
                            enabled: true, 
                            style: { fontSize: '12px', colors: ["#fff"] }, // Color blanco
                            // Sombra para mejor legibilidad
                            dropShadow: { enabled: true, top: 1, left: 1, blur: 1, color: '#000', opacity: 0.45 }
                        },
                        xaxis: { categories: chartData.categories, labels: { style: { fontSize: '12px' }, trim: true, maxHeight: 100 } },
                        yaxis: { labels: { formatter: val => val.toLocaleString('es-ES') } }
                    };
                } else if (type === 'line') {
                    options = {
                        ...commonOptions, series: chartData.series,
                        // FIX: Mostrar valores en puntos y líneas rectas.
                        stroke: { curve: 'straight', width: 3 }, 
                        markers: { size: 5 },
                        dataLabels: { enabled: true, background: { enabled: true, borderRadius: 2, padding: 4, opacity: 0.8 } },
                        xaxis: { type: 'datetime', categories: chartData.categories, labels: { datetimeUTC: false, format: 'dd/MM' } },
                        tooltip: { x: { format: 'dd/MM/yyyy' } }
                    };
                }

                if (charts[elementId]) {
                    charts[elementId].updateOptions(options);
                } else {
                    charts[elementId] = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    charts[elementId].render();
                }
            }
            
            function aggregateAndSort(data, categoryField, valueField, uniqueByIdProd = false, sortByValue = true) {
                const aggregation = {};
                const seenIds = new Set();
                data.forEach(row => {
                    const category = categoryField === 'Fecha' ? row[categoryField].toISOString().split('T')[0] : row[categoryField];
                    if (!category) return;
                    const value = row[valueField] || 0;
                    if (uniqueByIdProd) {
                        const uniqueKey = `${row.IdProduccion}-${category}`;
                        if (!seenIds.has(uniqueKey)) {
                            aggregation[category] = (aggregation[category] || 0) + value;
                            seenIds.add(uniqueKey);
                        }
                    } else {
                        aggregation[category] = (aggregation[category] || 0) + value;
                    }
                });

                let aggregatedArray = Object.keys(aggregation).map(key => ({ category: key, value: aggregation[key] }));
                if (sortByValue) {
                    aggregatedArray.sort((a, b) => b.value - a.value);
                } else if (categoryField === 'Fecha') {
                    aggregatedArray.sort((a, b) => new Date(a.category) - new Date(b.category));
                }
                return aggregatedArray;
            }
            init();
        });
    </script>
</body>
</html>
