<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard Gerencial de Producción</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/paparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #0d47a1; --secondary-color: #d32f2f; --accent-color: #ffc107;
            --bg-color: #f5f7fa; --card-bg: #ffffff; --text-color: #333; --text-muted: #6c757d;
            --border-radius: 10px; --box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        body { 
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            margin: 0; background-color: var(--bg-color); color: var(--text-color);
        }
        .main-container { padding: 25px; }
        .header, .controls, .card { 
            background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); margin-bottom: 25px;
        }
        h1, h2 { 
            color: var(--primary-color); text-align: center; margin-top: 0;
            border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;
        }
        h2 .fas { margin-right: 10px; }
        h3 { color: var(--primary-color); font-size: 1.4em; }

        /* Pestañas */
        .tabs { display: flex; justify-content: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .tab-button {
            padding: 12px 25px; font-size: 1.1em; cursor: pointer; border: 2px solid transparent;
            background-color: var(--card-bg); color: var(--primary-color); border-radius: 50px;
            transition: all 0.3s ease; font-weight: 600;
        }
        .tab-button.active, .tab-button:hover { background-color: var(--primary-color); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Controles y Filtros */
        .controls-container {
            display: flex; justify-content: center; align-items: center; gap: 25px; flex-wrap: wrap;
        }
        .controls-container label { font-weight: 600; color: var(--text-muted); font-size: 1.1em; }
        .controls-container input[type="date"], .controls-container select {
            padding: 12px; font-size: 1.1em; border: 1px solid #ccc;
            border-radius: 8px; background-color: #f8f9fa;
        }
        .btn {
            color: white; border: none; padding: 14px 30px; border-radius: 50px; cursor: pointer;
            font-size: 1.1em; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #applyFilterBtn { background: linear-gradient(45deg, #1976d2, #0d47a1); }
        #refreshBtn { background: linear-gradient(45deg, #6c757d, #343a40); }
        
        /* KPIs */
        .kpi-container { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px; text-align: center; 
        }
        .kpi-box { 
            background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); border-top: 5px solid;
        }
        .kpi-box.availability { border-color: var(--primary-color); }
        .kpi-box.performance { border-color: var(--accent-color); }
        .kpi-box.downtime { border-color: var(--secondary-color); }
        .kpi-box.production { border-color: #28a745; }
        .kpi-value { font-size: 2.8em; font-weight: 700; }
        .kpi-label { font-size: 1.1em; color: var(--text-muted); font-weight: 500; margin-top: 10px; }

        /* Gráficos */
        .charts-grid { 
            display: grid; grid-template-columns: 1fr; /* Cambiado para apilar los gráficos */
            gap: 25px; 
        }
        .chart-box { min-height: 480px; } /* Mayor altura para gráficos horizontales */
        .full-width { grid-column: 1 / -1; }

        /* Contenedor de Resumen */
        #summary-container {
            background-color: #e3f2fd; border-left: 5px solid var(--primary-color);
            margin-bottom: 25px; padding: 20px;
        }
        #summary-container ul { list-style: none; padding-left: 0; }
        #summary-container li { font-size: 1.2em; margin-bottom: 10px; }
        #summary-container li .fas { color: var(--primary-color); margin-right: 10px; }
        
        #status { margin-top: 20px; text-align: center; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header"><h1><i class="fas fa-chart-line"></i> Dashboard Gerencial de Producción</h1></div>
        
        <div class="controls">
            <div class="controls-container">
                <label for="startDate"><i class="fas fa-calendar-alt"></i> Desde:</label>
                <input type="date" id="startDate">
                <label for="endDate"><i class="fas fa-calendar-alt"></i> Hasta:</label>
                <input type="date" id="endDate">
                <label for="machineFilter"><i class="fas fa-cogs"></i> Máquina:</label>
                <select id="machineFilter"></select>
                <button id="applyFilterBtn" class="btn"><i class="fas fa-filter"></i> Aplicar</button>
                <button id="refreshBtn" class="btn"><i class="fas fa-sync-alt"></i> Limpiar</button>
            </div>
            <div id="status">Cargando datos...</div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab('gerencial')"><i class="fas fa-tachometer-alt"></i> Dashboard Gerencial</button>
            <button class="tab-button" onclick="openTab('causas')"><i class="fas fa-search-plus"></i> Causa Raíz</button>
            <button class="tab-button" onclick="openTab('rendimiento')"><i class="fas fa-chart-bar"></i> Rendimiento</button>
            <button class="tab-button" onclick="openTab('humano')"><i class="fas fa-users"></i> Factor Humano</button>
        </div>

        <div id="gerencial" class="tab-content active card">
            <h2><i class="fas fa-tachometer-alt"></i>Resumen Ejecutivo</h2>
            <div id="summary-container"></div>
            <div class="kpi-container" style="margin-bottom: 30px;">
                <div class="kpi-box availability"><div id="kpi-disponibilidad" class="kpi-value">-</div><div class="kpi-label">Disponibilidad</div></div>
                <div class="kpi-box performance"><div id="kpi-rendimiento" class="kpi-value">-</div><div class="kpi-label">Rendimiento (Uds/Hr)</div></div>
                <div class="kpi-box downtime"><div id="kpi-paradas" class="kpi-value">-</div><div class="kpi-label">Horas de Parada</div></div>
                <div class="kpi-box production"><div id="kpi-produccion" class="kpi-value">-</div><div class="kpi-label">Producción Total</div></div>
            </div>
            <div class="charts-grid"><div class="chart-box full-width card" id="chart_prod_disponibilidad_dia"></div></div>
        </div>

        <div id="causas" class="tab-content card">
            <h2><i class="fas fa-search-plus"></i>Análisis de Causas de Parada</h2>
             <div class="charts-grid">
                <div class="chart-box card" id="chart_pareto_incidencia"></div>
                <div class="chart-box card" id="chart_desglose_maquina"></div> </div>
        </div>
        
        <div id="rendimiento" class="tab-content card" style="display: none;">
             <h2><i class="fas fa-chart-bar"></i>Análisis de Rendimiento y Comparativas</h2>
            <div class="charts-grid" style="grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));">
                <div class="chart-box card" id="chart_prod_maquina"></div>
                <div class="chart-box card" id="chart_rendimiento_maquina"></div>
                <div class="chart-box full-width card" id="chart_paradas_turno"></div>
            </div>
        </div>

        <div id="humano" class="tab-content card" style="display: none;">
            <h2><i class="fas fa-users"></i>Análisis de Factor Humano</h2>
            <div class="charts-grid">
                <div class="chart-box full-width card" id="chart_pareto_operario"></div>
            </div>
        </div>
    </div>

<script>
    let globalData = [];
    const statusDiv = document.getElementById('status');
    const localCsvFile = 'exportProduccionyEventos.csv';

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('applyFilterBtn').addEventListener('click', () => updateDashboard(globalData));
        document.getElementById('refreshBtn').addEventListener('click', () => {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('machineFilter').value = 'all';
            updateDashboard(globalData);
        });
        loadAndProcessData();
    });

    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        // Pequeño hack para redibujar los gráficos de plotly al cambiar de pestaña
        setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 10);
    }

    async function loadAndProcessData() {
        // ... (sin cambios en esta función)
        statusDiv.textContent = `Cargando archivo '${localCsvFile}'...`;
        try {
            const response = await fetch(localCsvFile);
            if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                header: true, skipEmptyLines: true, delimiter: ";",
                complete: (results) => {
                    globalData = results.data.map(row => ({
                        ...row,
                        fechaObj: new Date(row.Fecha.split('/').reverse().join('-'))
                    }));

                    const machineFilter = document.getElementById('machineFilter');
                    const uniqueMachines = [...new Set(globalData.map(row => row['Descrip_Maquina'] || 'N/A'))].sort();
                    machineFilter.innerHTML = '<option value="all">-- Todas las Máquinas --</option>';
                    uniqueMachines.forEach(machine => {
                        const option = document.createElement('option');
                        option.value = machine;
                        option.textContent = machine;
                        machineFilter.appendChild(option);
                    });

                    updateDashboard(globalData);
                    statusDiv.textContent = `Datos cargados. ${globalData.length} registros encontrados.`;
                    statusDiv.style.color = 'green';
                },
                error: (err) => { throw new Error(err.message); }
            });
        } catch (error) {
            statusDiv.textContent = `Error: No se pudo cargar '${localCsvFile}'.`;
            statusDiv.style.color = 'red';
        }
    }
    
    function parseCustomFloat(value) {
        return parseFloat((String(value) || '0').replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    function updateDashboard(sourceData) {
        // ... (sin cambios en la lógica de filtrado inicial)
        const startDate = document.getElementById('startDate').valueAsDate;
        const endDate = document.getElementById('endDate').valueAsDate;
        const selectedMachine = document.getElementById('machineFilter').value;

        const filteredData = sourceData.filter(row => {
            let dateFilterPassed = true;
            if(startDate && endDate){
                const endOfDayEndDate = new Date(endDate);
                endOfDayEndDate.setHours(23, 59, 59, 999);
                dateFilterPassed = row.fechaObj >= startDate && row.fechaObj <= endOfDayEndDate;
            }
            const machineFilterPassed = (selectedMachine === 'all') || (row['Descrip_Maquina'] === selectedMachine);
            return dateFilterPassed && machineFilterPassed;
        });

        if (filteredData.length === 0) {
            statusDiv.textContent = 'No hay datos para la selección actual.';
            // ... (código para limpiar el dashboard)
            return;
        }
        statusDiv.textContent = `Mostrando ${[...new Set(filteredData.map(r => r.IdProduccion))].length} órdenes de producción.`;

        // --- 1. PROCESAMIENTO DE DATOS --- (sin cambios)
        const produccionUnica = new Map();
        filteredData.forEach(row => {
            if (!produccionUnica.has(row.IdProduccion)) {
                produccionUnica.set(row.IdProduccion, {
                    Cantidad: parseCustomFloat(row.Cantidad), HsTrab: parseInt(row['Hs Trab'], 10) || 0,
                    Descrip_Maquina: row['Descrip_Maquina'] || 'N/A', Fecha: row.Fecha,
                });
            }
        });
        const produccionArray = Array.from(produccionUnica.values());

        const paradasData = filteredData.map(row => ({
            Minutos: parseInt(row.Minutos, 10) || 0,
            Descrip_Maquina: row['Descrip_Maquina'] || 'N/A',
            descrip_incidencia: row['descrip_incidencia'] || 'No especificada',
            Turno: row.Turno || 'N/A', Apellido: row.Apellido || 'N/A', Fecha: row.Fecha
        }));

        // --- 2. CÁLCULO DE KPIs --- (sin cambios)
        const totalProduccion = produccionArray.reduce((sum, r) => sum + r.Cantidad, 0);
        const totalMinutosParada = paradasData.reduce((sum, r) => sum + r.Minutos, 0);
        const totalMinutosPlanificados = produccionArray.reduce((sum, r) => sum + r.HsTrab, 0);
        const tiempoOperativoMinutos = Math.max(0, totalMinutosPlanificados - totalMinutosParada);
        const disponibilidad = totalMinutosPlanificados > 0 ? (tiempoOperativoMinutos / totalMinutosPlanificados) * 100 : 0;
        const rendimiento = tiempoOperativoMinutos > 0 ? totalProduccion / (tiempoOperativoMinutos / 60) : 0;

        document.getElementById('kpi-produccion').textContent = totalProduccion.toLocaleString('es-AR', {maximumFractionDigits:0});
        document.getElementById('kpi-paradas').textContent = (totalMinutosParada / 60).toFixed(1);
        document.getElementById('kpi-disponibilidad').textContent = `${disponibilidad.toFixed(1)}%`;
        document.getElementById('kpi-rendimiento').textContent = rendimiento.toLocaleString('es-AR', {maximumFractionDigits:0});
        
        // --- 3. PREPARACIÓN DE DATOS PARA GRÁFICOS --- (con cambios)
        const groupBy = (arr, key, valueKey) => arr.reduce((acc, r) => {
            const group = r[key];
            acc[group] = (acc[group] || 0) + r[valueKey];
            return acc;
        }, {});
        
        // ... (dataEvolutivo y paretoOperarioData sin cambios)
        const produccionPorDia = groupBy(produccionArray, 'Fecha', 'Cantidad');
        const paradasPorDia = groupBy(paradasData, 'Fecha', 'Minutos');
        const planificadoPorDia = groupBy(produccionArray, 'Fecha', 'HsTrab');
        const sortedFechas = Object.keys(produccionPorDia).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
        const dataEvolutivo = sortedFechas.map(fecha => {
            const planificado = planificadoPorDia[fecha] || 0;
            const paradas = paradasPorDia[fecha] || 0;
            return { fecha, produccion: produccionPorDia[fecha] || 0, disponibilidad: planificado > 0 ? ((planificado - paradas) / planificado) * 100 : 0 };
        });
        const paradasPorOperario = groupBy(paradasData.filter(d => d.Apellido !== 'N/A'), 'Apellido', 'Minutos');
        let cumulativeOp = 0;
        const totalParadasOp = Object.values(paradasPorOperario).reduce((s,v) => s+v, 0);
        const paretoOperarioData = Object.entries(paradasPorOperario).sort(([,a],[,b]) => b-a).slice(0, 15).map(([operario, minutos]) => {
            cumulativeOp += minutos;
            return { operario, minutos, cum_percent: totalParadasOp > 0 ? (cumulativeOp / totalParadasOp) * 100 : 0 };
        });

        const paradasPorCausa = groupBy(paradasData, 'descrip_incidencia', 'Minutos');
        let cumulative = 0;
        const paretoData = Object.entries(paradasPorCausa).sort(([,a],[,b]) => a-b).map(([causa, minutos]) => { // Orden ascendente para gráfico horizontal
            cumulative += minutos;
            return { causa, minutos, cum_percent: totalMinutosParada > 0 ? (cumulative / totalMinutosParada) * 100 : 0 };
        });
        
        // ===== NUEVA LÓGICA PARA BARRAS APILADAS =====
        const causasUnicas = [...new Set(paradasData.map(d => d.descrip_incidencia))];
        const maquinasUnicas = [...new Set(paradasData.map(d => d.Descrip_Maquina))];
        const desgloseData = causasUnicas.map(causa => {
            return {
                x: maquinasUnicas.map(maquina => paradasData.filter(d => d.Descrip_Maquina === maquina && d.descrip_incidencia === causa).reduce((sum, r) => sum + r.Minutos, 0)),
                y: maquinasUnicas,
                name: causa,
                type: 'bar',
                orientation: 'h'
            };
        });
        
        const rendimientoPorMaquina = maquinasUnicas.map(maquina => {
            const prod = produccionArray.filter(p => p.Descrip_Maquina === maquina).reduce((s, r) => s + r.Cantidad, 0);
            const tPlanificado = produccionArray.filter(p => p.Descrip_Maquina === maquina).reduce((s, r) => s + r.HsTrab, 0);
            const tParada = paradasData.filter(p => p.Descrip_Maquina === maquina).reduce((s, r) => s + r.Minutos, 0);
            const tOperativo = (tPlanificado - tParada) / 60;
            return { maquina, produccion: prod, rendimiento: tOperativo > 0 ? prod / tOperativo : 0, disponibilidad: tPlanificado > 0 ? ((tPlanificado - tParada) / tPlanificado) * 100 : 0 };
        }).sort((a,b) => b.produccion - a.produccion);

        // --- 4. GENERACIÓN DE RESUMEN AUTOMÁTICO ---
        generateSummary({disponibilidad, rendimiento}, paretoData, rendimientoPorMaquina);

        // --- 5. RENDERIZADO DE GRÁFICOS ---
        const plotlyConfig = {responsive: true, displaylogo: false};
        const baseLayout = (title) => ({ title: { text: title, font: {size: 20, color: 'var(--primary-color)'}}, paper_bgcolor: 'var(--card-bg)', plot_bgcolor: '#f5f7fa', margin: { l: 250, r: 50, b: 50, t: 80 } }); // Aumentar margen izquierdo

        // ... (Gráfico de gerencial y operario sin cambios)
        Plotly.react('chart_prod_disponibilidad_dia', [{ x: dataEvolutivo.map(d => d.fecha), y: dataEvolutivo.map(d => d.produccion), name: 'Producción', type: 'bar', marker: {color: 'var(--primary-color)'} }, { x: dataEvolutivo.map(d => d.fecha), y: dataEvolutivo.map(d => d.disponibilidad), name: 'Disponibilidad', type: 'scatter', mode: 'lines+markers', yaxis: 'y2', line: {color: 'var(--accent-color)', width: 3} }], { ...baseLayout('Producción y Disponibilidad Diaria'), yaxis: {title: 'Producción (Unidades)'}, yaxis2: {title: 'Disponibilidad (%)', overlaying: 'y', side: 'right', range: [0, 105]}, legend: {orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center'}, margin: {l: 50} }, plotlyConfig);
        Plotly.react('chart_pareto_operario', [{ x: paretoOperarioData.map(d => d.minutos), y: paretoOperarioData.map(d => d.operario).reverse(), name: 'Minutos de Parada', type: 'bar', orientation: 'h', marker: {color: '#6a1b9a'} }, { x: paretoOperarioData.map(d => d.cum_percent), y: paretoOperarioData.map(d => d.operario).reverse(), name: '% Acumulado', type: 'scatter', mode: 'lines+markers', xaxis: 'x2', line: {color: 'var(--primary-color)', width: 3} }], { ...baseLayout('Top 15 Operarios por Tiempo de Parada'), xaxis: {title: 'Minutos Totales de Parada'}, xaxis2: {title: '% Acumulado', overlaying: 'x', side: 'top', range: [0, 105]}, yaxis: { categoryorder: 'total ascending' }, legend: {orientation: 'h', y: -0.2, x: 0.5, xanchor: 'center'} }, plotlyConfig);

        // ===== GRÁFICOS DE CAUSA RAÍZ ACTUALIZADOS =====
        Plotly.react('chart_pareto_incidencia', [{ 
            x: paretoData.map(d => d.minutos), 
            y: paretoData.map(d => d.causa),
            name: 'Minutos de Parada', type: 'bar', orientation: 'h', marker: {color: 'var(--secondary-color)'} 
        }], { 
            ...baseLayout('Principales Causas de Parada'),
            xaxis: {title: 'Minutos Totales de Parada'},
            yaxis: { categoryorder: 'total ascending' },
        }, plotlyConfig);

        Plotly.react('chart_desglose_maquina', desgloseData, { 
            ...baseLayout('Composición de Paradas por Máquina'),
            barmode: 'stack',
            xaxis: {title: 'Minutos Totales de Parada'},
            yaxis: { categoryorder: 'total descending'},
            legend: {orientation: 'h', y: -0.3, x: 0.5, xanchor: 'center'}
        }, plotlyConfig);

        // ... (Gráficos de rendimiento y turno sin cambios)
        Plotly.react('chart_prod_maquina', [{ x: rendimientoPorMaquina.map(d => d.maquina), y: rendimientoPorMaquina.map(d => d.produccion), type: 'bar', text: rendimientoPorMaquina.map(d => d.produccion.toLocaleString('es-AR')), textposition: 'auto', marker: {color: '#28a745'} }], { ...baseLayout('Producción Total por Máquina'), margin: {l:50}}, plotlyConfig);
        Plotly.react('chart_rendimiento_maquina', [{ x: rendimientoPorMaquina.map(d => d.maquina), y: rendimientoPorMaquina.map(d => d.rendimiento), type: 'bar', text: rendimientoPorMaquina.map(d => Math.round(d.rendimiento).toLocaleString('es-AR')), textposition: 'auto', marker: {color: 'var(--accent-color)'} }], { ...baseLayout('Rendimiento (Unidades por Hora) por Máquina'), margin: {l:50}}, plotlyConfig);
        const turnoData = Object.entries(groupBy(paradasData, 'Turno', 'Minutos')).sort(([,a],[,b]) => b - a);
        Plotly.react('chart_paradas_turno', [{ labels: turnoData.map(d => d[0]), values: turnoData.map(d => d[1]), type: 'pie', hole: .4, textinfo: 'label+percent', marker: { colors: ['#0d47a1', '#1976d2', '#42a5f5', '#90caf9']} }], { ...baseLayout('Distribución de Paradas por Turno'), margin: {l:50}}, plotlyConfig);
    }

    function generateSummary(kpis, pareto, maquinas) {
        // ... (sin cambios en esta función)
        let summaryHTML = '<h3><i class="fas fa-lightbulb"></i> Resumen y Conclusiones Clave</h3><ul>';
        if (pareto.length > 0) {
            const topCausa = pareto[pareto.length-1]; // El último es el mayor en orden ascendente
            const totalParadas = pareto.reduce((sum, item) => sum + item.minutos, 0);
            const porcentajeTopCausa = totalParadas > 0 ? (topCausa.minutos / totalParadas) * 100 : 0;
            summaryHTML += `<li><i class="fas fa-exclamation-triangle"></i> La principal causa de paradas es <strong>${topCausa.causa}</strong>, responsable del <strong>${Math.round(porcentajeTopCausa)}%</strong> del tiempo total perdido.</li>`;
        }
        if (maquinas.length > 0) {
            const maquinaMenorDisp = maquinas.sort((a,b) => a.disponibilidad - b.disponibilidad)[0];
             if(maquinaMenorDisp) {
                summaryHTML += `<li><i class="fas fa-cogs"></i> La máquina con menor disponibilidad es <strong>${maquinaMenorDisp.maquina}</strong>, operando solo un <strong>${maquinaMenorDisp.disponibilidad.toFixed(1)}%</strong> del tiempo planificado.</li>`;
             }
        }
        if (kpis.rendimiento) {
             summaryHTML += `<li><i class="fas fa-tachometer-alt"></i> El rendimiento general de la planta en el período es de <strong>${Math.round(kpis.rendimiento)} unidades por hora</strong> de trabajo efectivo.</li>`;
        }
        summaryHTML += '</ul>';
        document.getElementById('summary-container').innerHTML = summaryHTML;
    }
</script>
</body>
</html>
