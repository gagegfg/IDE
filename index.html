<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Rendimiento Industrial</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .card-title {
            font-weight: 500;
            color: #495057;
        }
        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #212529;
        }
        .chart-container {
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
        }
        .filter-section {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        h1, h2, h3 {
            font-weight: 700;
        }
    </style>
</head>
<body>
    <main class="container-fluid mt-4">
        <header class="mb-4">
            <h1 class="text-center">Dashboard de Rendimiento de Equipos</h1>
            <p class="text-center text-muted" id="last-updated">Datos actualizados por última vez: Cargando...</p>
        </header>

        <!-- Filtros -->
        <section class="filter-section card">
            <h3 class="mb-3">Filtros</h3>
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label for="date-range-picker" class="form-label">Rango de Fechas</label>
                    <input type="text" class="form-control" id="date-range-picker" placeholder="Seleccionar rango...">
                </div>
                <div class="col-md-4">
                    <label for="machine-filter" class="form-label">Máquinas</label>
                    <select id="machine-filter" class="form-select" multiple>
                        <!-- Opciones de máquinas se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="shift-filter" class="form-label">Turnos</label>
                    <select id="shift-filter" class="form-select" multiple>
                        <!-- Opciones de turnos se cargarán dinámicamente -->
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="apply-filters" class="btn btn-primary w-100">Aplicar</button>
                </div>
            </div>
        </section>

        <!-- KPIs -->
        <section class="row mb-4 g-4">
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <div class="card-body">
                        <h5 class="card-title">Producción Total</h5>
                        <p class="kpi-value" id="kpi-total-production">--</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <div class="card-body">
                        <h5 class="card-title">Horas de Parada</h5>
                        <p class="kpi-value" id="kpi-total-downtime">--</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <div class="card-body">
                        <h5 class="card-title">Eficiencia (Prod/Hora)</h5>
                        <p class="kpi-value" id="kpi-efficiency">--</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <div class="card-body">
                        <h5 class="card-title">Máquinas Activas</h5>
                        <p class="kpi-value" id="kpi-active-machines">--</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Resumen Gerencial -->
        <section class="row mb-4 g-4">
            <div class="col-12">
                <div class="card p-3">
                    <div class="card-body">
                        <h3 class="card-title">Resumen Gerencial</h3>
                        <p id="summary-text">Calculando...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gráficos -->
        <section class="row g-4">
            <div class="col-lg-6 mb-4">
                <div class="card chart-container">
                    <h3 class="mb-3">Producción por Máquina</h3>
                    <div id="chart-prod-by-machine"></div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card chart-container">
                    <h3 class="mb-3">Principales Causas de Parada (Minutos)</h3>
                    <div id="chart-downtime-reasons"></div>
                </div>
            </div>
            <div class="col-lg-12 mb-4">
                <div class="card chart-container">
                    <h3 class="mb-3">Producción Diaria</h3>
                    <div id="chart-daily-production"></div>
                </div>
            </div>
        </section>

    </main>

    <!-- Librerías JS -->
    <!-- PapaParse para CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Flatpickr para Rango de Fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <!-- Lógica del Dashboard -->
    <script>
        // El código JavaScript para cargar datos y renderizar los gráficos irá aquí.
        document.addEventListener('DOMContentLoaded', function () {
            const CSV_URL = 'exportProduccionyEventos.csv';

            // Instancias de los gráficos (se inicializan una vez)
            let prodByMachineChart, downtimeReasonsChart, dailyProductionChart;

            // Contenedor para los datos originales
            let originalData = [];

            // --- INICIALIZACIÓN ---
            function init() {
                Papa.parse(CSV_URL, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    transformHeader: header => header.trim().replace(/ /g, '_'),
                    complete: function(results) {
                        originalData = processData(results.data);
                        populateFilters(originalData);
                        updateDashboard(originalData);
                        document.getElementById('last-updated').textContent = `Datos actualizados por última vez: ${new Date().toLocaleString('es-ES')}`;
                    },
                    error: function(err) {
                        console.error("Error al cargar o parsear el CSV:", err);
                        alert("No se pudo cargar el archivo de datos. Revisa la consola para más detalles.");
                    }
                });

                document.getElementById('apply-filters').addEventListener('click', applyFilters);
            }

            // --- PROCESAMIENTO DE DATOS ---
            function processData(data) {
                return data.map(row => {
                    // Limpieza y conversión de tipos
                    row.Cantidad = parseInt(row.Cantidad) || 0;
                    row.Minutos = parseInt(row.Minutos) || 0;
                    row.IdProduccion = row.IdProduccion;
                    row.Fecha = parseDate(row.Fecha); // Convertir a objeto Date
                    return row;
                });
            }
            
            function parseDate(dateString) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    // Formato dd/mm/yyyy
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return null;
            }

            // --- FILTROS ---
            function populateFilters(data) {
                const uniqueMachines = [...new Set(data.map(row => row.Descrip_Maquina))].sort();
                const uniqueShifts = [...new Set(data.map(row => row.Turno))].sort();

                const machineFilter = document.getElementById('machine-filter');
                uniqueMachines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine;
                    option.textContent = machine;
                    machineFilter.appendChild(option);
                });

                const shiftFilter = document.getElementById('shift-filter');
                uniqueShifts.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = shift;
                    option.textContent = shift;
                    shiftFilter.appendChild(option);
                });

                // Inicializar Flatpickr
                flatpickr("#date-range-picker", {
                    mode: "range",
                    dateFormat: "d/m/Y",
                    locale: "es",
                    defaultDate: [data[0].Fecha, data[data.length - 1].Fecha] // Rango por defecto
                });
            }

            function applyFilters() {
                const dateRange = document.getElementById('date-range-picker')._flatpickr.selectedDates;
                const selectedMachines = Array.from(document.getElementById('machine-filter').selectedOptions).map(opt => opt.value);
                const selectedShifts = Array.from(document.getElementById('shift-filter').selectedOptions).map(opt => opt.value);

                let filteredData = originalData.filter(row => {
                    const rowDate = row.Fecha;
                    const isDateInRange = dateRange.length === 2 ? rowDate >= dateRange[0] && rowDate <= dateRange[1] : true;
                    const isMachineSelected = selectedMachines.length > 0 ? selectedMachines.includes(row.Descrip_Maquina) : true;
                    const isShiftSelected = selectedShifts.length > 0 ? selectedShifts.includes(row.Turno) : true;
                    return isDateInRange && isMachineSelected && isShiftSelected;
                });

                updateDashboard(filteredData);
            }

            // --- ACTUALIZACIÓN DEL DASHBOARD ---
            function updateDashboard(data) {
                updateKPIs(data);
                updateCharts(data);
                updateSummary(data);
            }

            // --- CÁLCULO Y RENDER DE KPIs ---
            function updateKPIs(data) {
                const uniqueProductions = new Map();
                data.forEach(row => {
                    if (!uniqueProductions.has(row.IdProduccion)) {
                        uniqueProductions.set(row.IdProduccion, { 
                            cantidad: row.Cantidad, 
                            hsTrab: parseFloat(row.Hs_Trab) || 0 
                        });
                    }
                });

                const totalProduction = Array.from(uniqueProductions.values()).reduce((sum, item) => sum + item.cantidad, 0);
                const totalWorkHours = Array.from(uniqueProductions.values()).reduce((sum, item) => sum + item.hsTrab, 0) / 60; // a horas

                const totalDowntime = data.reduce((sum, row) => sum + row.Minutos, 0) / 60; // a horas
                const activeMachines = new Set(data.map(row => row.Descrip_Maquina)).size;
                const efficiency = totalWorkHours > 0 ? totalProduction / totalWorkHours : 0;

                document.getElementById('kpi-total-production').textContent = totalProduction.toLocaleString('es-ES');
                document.getElementById('kpi-total-downtime').textContent = totalDowntime.toFixed(1);
                document.getElementById('kpi-efficiency').textContent = efficiency.toFixed(0);
                document.getElementById('kpi-active-machines').textContent = activeMachines;
            }
            
            // --- RESUMEN GERENCIAL ---
            function updateSummary(data) {
                if (data.length === 0) {
                    document.getElementById('summary-text').textContent = "No hay datos para el período o filtros seleccionados.";
                    return;
                }

                // Máquina con mayor producción
                const prodByMachine = aggregate(data, 'Descrip_Maquina', 'Cantidad', 'sum', true);
                const topMachine = Object.keys(prodByMachine).reduce((a, b) => prodByMachine[a] > prodByMachine[b] ? a : b, "N/A");

                // Causa principal de parada
                const downtimeByReason = aggregate(data, 'descrip_incidencia', 'Minutos', 'sum');
                const topReason = Object.keys(downtimeByReason).reduce((a, b) => downtimeByReason[a] > downtimeByReason[b] ? a : b, "N/A");

                const summary = `
                    La máquina con mayor producción fue **${topMachine}**. 
                    La principal causa de tiempo de parada fue **"${topReason}"**, acumulando un total de **${(downtimeByReason[topReason] || 0).toFixed(0)} minutos**.
                `;
                document.getElementById('summary-text').innerHTML = summary.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            }

            // --- LÓGICA DE GRÁFICOS ---
            function updateCharts(data) {
                // 1. Producción por Máquina
                const prodByMachineData = aggregate(data, 'Descrip_Maquina', 'Cantidad', 'sum', true);
                renderBarChart('chart-prod-by-machine', prodByMachineChart, Object.keys(prodByMachineData), Object.values(prodByMachineData), 'Producción Total', false);

                // 2. Causas de Parada
                const downtimeReasonsData = aggregate(data, 'descrip_incidencia', 'Minutos', 'sum');
                renderBarChart('chart-downtime-reasons', downtimeReasonsChart, Object.keys(downtimeReasonsData), Object.values(downtimeReasonsData), 'Minutos Totales de Parada', true);

                // 3. Producción Diaria
                const dailyProdData = aggregate(data, 'Fecha', 'Cantidad', 'sum', true);
                renderLineChart('chart-daily-production', dailyProductionChart, Object.keys(dailyProdData), Object.values(dailyProdData), 'Producción Diaria');
            }

            function renderBarChart(elementId, chartInstance, categories, seriesData, seriesName, isHorizontal) {
                const options = {
                    series: [{ name: seriesName, data: seriesData }],
                    chart: { type: 'bar', height: 350, toolbar: { show: false } },
                    plotOptions: { bar: { horizontal: isHorizontal, columnWidth: '55%', endingShape: 'rounded' } },
                    dataLabels: { enabled: false },
                    stroke: { show: true, width: 2, colors: ['transparent'] },
                    xaxis: { categories: categories, labels: { style: { fontSize: '12px' } } },
                    yaxis: { title: { text: isHorizontal ? '' : seriesName } },
                    fill: { opacity: 1 },
                    tooltip: { y: { formatter: val => val.toLocaleString('es-ES') } }
                };
                if (chartInstance) {
                    chartInstance.updateOptions(options);
                } else {
                    chartInstance = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    chartInstance.render();
                }
            }

            function renderLineChart(elementId, chartInstance, categories, seriesData, seriesName) {
                const options = {
                    series: [{ name: seriesName, data: seriesData }],
                    chart: { type: 'line', height: 350, zoom: { enabled: true }, toolbar: { show: true } },
                    dataLabels: { enabled: true },
                    stroke: { curve: 'smooth' },
                    xaxis: { 
                        type: 'datetime',
                        categories: categories,
                        labels: { datetimeUTC: false, format: 'dd/MM' }
                    },
                    tooltip: { x: { format: 'dd/MM/yyyy' } }
                };
                if (chartInstance) {
                    chartInstance.updateOptions(options);
                } else {
                    chartInstance = new ApexCharts(document.querySelector(`#${elementId}`), options);
                    chartInstance.render();
                }
            }

            // --- FUNCIÓN UTILITARIA DE AGREGACIÓN ---
            function aggregate(data, categoryField, valueField, method = 'sum', uniqueByIdProd = false) {
                const result = {};
                const seenIds = new Set();

                data.forEach(row => {
                    const category = categoryField === 'Fecha' ? row[categoryField].toISOString().split('T')[0] : row[categoryField];
                    if (!category) return;

                    if (uniqueByIdProd) {
                        const uniqueKey = `${row.IdProduccion}`;
                        if (!seenIds.has(uniqueKey)) {
                            result[category] = (result[category] || 0) + row[valueField];
                            seenIds.add(uniqueKey);
                        }
                    } else {
                        result[category] = (result[category] || 0) + row[valueField];
                    }
                });
                return result;
            }

            // --- Iniciar la aplicación ---
            init();
        });
    </script>
</body>
</html>
